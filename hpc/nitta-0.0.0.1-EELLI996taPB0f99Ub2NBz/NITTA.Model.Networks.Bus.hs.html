<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
span.lineno { color: white; background: #aaaaaa; border-right: solid white 12px }
span.nottickedoff { background: yellow}
span.istickedoff { background: white }
span.tickonlyfalse { margin: -1px; border: 1px solid #f20913; background: #f20913 }
span.tickonlytrue  { margin: -1px; border: 1px solid #60de51; background: #60de51 }
span.funcount { font-size: small; color: orange; z-index: 2; position: absolute; right: 20 }
span.decl { font-weight: bold }
span.spaces    { background: white }
</style>
</head>
<body>
<pre>
<span class="decl"><span class="nottickedoff">never executed</span> <span class="tickonlytrue">always true</span> <span class="tickonlyfalse">always false</span></span>
</pre>
<pre>
<span class="lineno">    1 </span>{-# LANGUAGE ConstraintKinds #-}
<span class="lineno">    2 </span>{-# LANGUAGE FlexibleContexts #-}
<span class="lineno">    3 </span>{-# LANGUAGE FlexibleInstances #-}
<span class="lineno">    4 </span>{-# LANGUAGE LambdaCase #-}
<span class="lineno">    5 </span>{-# LANGUAGE MultiParamTypeClasses #-}
<span class="lineno">    6 </span>{-# LANGUAGE MultiWayIf #-}
<span class="lineno">    7 </span>{-# LANGUAGE NamedFieldPuns #-}
<span class="lineno">    8 </span>{-# LANGUAGE OverloadedStrings #-}
<span class="lineno">    9 </span>{-# LANGUAGE QuasiQuotes #-}
<span class="lineno">   10 </span>{-# LANGUAGE RecordWildCards #-}
<span class="lineno">   11 </span>{-# LANGUAGE ScopedTypeVariables #-}
<span class="lineno">   12 </span>{-# LANGUAGE TupleSections #-}
<span class="lineno">   13 </span>{-# LANGUAGE TypeFamilies #-}
<span class="lineno">   14 </span>{-# LANGUAGE UndecidableInstances #-}
<span class="lineno">   15 </span>
<span class="lineno">   16 </span>{- |
<span class="lineno">   17 </span>Module      : NITTA.Model.Networks.Bus
<span class="lineno">   18 </span>Description : Simple process unit network - pseudo bus.
<span class="lineno">   19 </span>Copyright   : (c) Aleksandr Penskoi, 2019
<span class="lineno">   20 </span>License     : BSD3
<span class="lineno">   21 </span>Maintainer  : aleksandr.penskoi@gmail.com
<span class="lineno">   22 </span>Stability   : experimental
<span class="lineno">   23 </span>
<span class="lineno">   24 </span>For creating BusNetwork see 'NITTA.Model.Microarchitecture.Builder'.
<span class="lineno">   25 </span>-}
<span class="lineno">   26 </span>module NITTA.Model.Networks.Bus (
<span class="lineno">   27 </span>    BusNetwork (..),
<span class="lineno">   28 </span>    Ports (..),
<span class="lineno">   29 </span>    IOPorts (..),
<span class="lineno">   30 </span>    bindedFunctions,
<span class="lineno">   31 </span>    controlSignalLiteral,
<span class="lineno">   32 </span>    busNetwork,
<span class="lineno">   33 </span>) where
<span class="lineno">   34 </span>
<span class="lineno">   35 </span>import Control.Monad.State
<span class="lineno">   36 </span>import Data.Bifunctor
<span class="lineno">   37 </span>import Data.Default
<span class="lineno">   38 </span>import qualified Data.List as L
<span class="lineno">   39 </span>import qualified Data.Map.Strict as M
<span class="lineno">   40 </span>import Data.Maybe
<span class="lineno">   41 </span>import qualified Data.Set as S
<span class="lineno">   42 </span>import Data.String.Interpolate
<span class="lineno">   43 </span>import Data.String.ToString
<span class="lineno">   44 </span>import qualified Data.Text as T
<span class="lineno">   45 </span>import Data.Typeable
<span class="lineno">   46 </span>import NITTA.Intermediate.Types
<span class="lineno">   47 </span>import NITTA.Model.Networks.Types
<span class="lineno">   48 </span>import NITTA.Model.Problems
<span class="lineno">   49 </span>import NITTA.Model.ProcessorUnits.Types
<span class="lineno">   50 </span>import NITTA.Model.Time
<span class="lineno">   51 </span>import NITTA.Project.TestBench
<span class="lineno">   52 </span>import NITTA.Project.Types
<span class="lineno">   53 </span>import NITTA.Project.VerilogSnippets
<span class="lineno">   54 </span>import NITTA.Utils
<span class="lineno">   55 </span>import NITTA.Utils.ProcessDescription
<span class="lineno">   56 </span>import Numeric.Interval.NonEmpty (inf, sup, (...))
<span class="lineno">   57 </span>import qualified Numeric.Interval.NonEmpty as I
<span class="lineno">   58 </span>import Prettyprinter
<span class="lineno">   59 </span>import Text.Regex
<span class="lineno">   60 </span>
<span class="lineno">   61 </span>data BusNetwork tag v x t = BusNetwork
<span class="lineno">   62 </span>    { <span class="nottickedoff"><span class="decl"><span class="nottickedoff">bnName</span></span></span> :: tag
<span class="lineno">   63 </span>    , -- |List of functions binded to network, but not binded to any process unit.
<span class="lineno">   64 </span>      <span class="nottickedoff"><span class="decl"><span class="nottickedoff">bnRemains</span></span></span> :: [F v x]
<span class="lineno">   65 </span>    , -- |Map process unit name to list of binded functions.
<span class="lineno">   66 </span>      <span class="nottickedoff"><span class="decl"><span class="nottickedoff">bnBinded</span></span></span> :: M.Map tag [F v x]
<span class="lineno">   67 </span>    , -- |Network process (bindings and transport instructions)
<span class="lineno">   68 </span>      <span class="nottickedoff"><span class="decl"><span class="nottickedoff">bnProcess</span></span></span> :: Process t (StepInfo v x t)
<span class="lineno">   69 </span>    , -- |Map of process units.
<span class="lineno">   70 </span>      <span class="nottickedoff"><span class="decl"><span class="nottickedoff">bnPus</span></span></span> :: M.Map tag (PU v x t)
<span class="lineno">   71 </span>    , -- |Controll bus width.
<span class="lineno">   72 </span>      <span class="nottickedoff"><span class="decl"><span class="nottickedoff">bnSignalBusWidth</span></span></span> :: Int
<span class="lineno">   73 </span>    , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">ioSync</span></span></span> :: IOSynchronization
<span class="lineno">   74 </span>    , <span class="istickedoff"><span class="decl"><span class="istickedoff">bnEnv</span></span></span> :: UnitEnv (BusNetwork tag v x t)
<span class="lineno">   75 </span>    }
<span class="lineno">   76 </span>
<span class="lineno">   77 </span><span class="decl"><span class="istickedoff">busNetwork name iosync =</span>
<span class="lineno">   78 </span><span class="spaces">    </span><span class="istickedoff">BusNetwork</span>
<span class="lineno">   79 </span><span class="spaces">        </span><span class="istickedoff">{ bnName = name</span>
<span class="lineno">   80 </span><span class="spaces">        </span><span class="istickedoff">, bnRemains = []</span>
<span class="lineno">   81 </span><span class="spaces">        </span><span class="istickedoff">, bnBinded = M.empty</span>
<span class="lineno">   82 </span><span class="spaces">        </span><span class="istickedoff">, bnProcess = def</span>
<span class="lineno">   83 </span><span class="spaces">        </span><span class="istickedoff">, bnPus = M.empty</span>
<span class="lineno">   84 </span><span class="spaces">        </span><span class="istickedoff">, bnSignalBusWidth = 0</span>
<span class="lineno">   85 </span><span class="spaces">        </span><span class="istickedoff">, ioSync = iosync</span>
<span class="lineno">   86 </span><span class="spaces">        </span><span class="istickedoff">, bnEnv = def</span>
<span class="lineno">   87 </span><span class="spaces">        </span><span class="istickedoff">}</span></span>
<span class="lineno">   88 </span>
<span class="lineno">   89 </span>instance (Var v) =&gt; Variables (BusNetwork tag v x t) v where
<span class="lineno">   90 </span>    <span class="decl"><span class="istickedoff">variables BusNetwork{bnBinded} = unionsMap variables $ concat $ M.elems bnBinded</span></span>
<span class="lineno">   91 </span>
<span class="lineno">   92 </span><span class="decl"><span class="istickedoff">bindedFunctions puTitle BusNetwork{bnBinded}</span>
<span class="lineno">   93 </span><span class="spaces">    </span><span class="istickedoff">| puTitle `M.member` bnBinded = bnBinded M.! puTitle</span>
<span class="lineno">   94 </span><span class="spaces">    </span><span class="istickedoff">| <span class="tickonlytrue">otherwise</span> = []</span></span>
<span class="lineno">   95 </span>
<span class="lineno">   96 </span>instance (Default x) =&gt; DefaultX (BusNetwork tag v x t) x
<span class="lineno">   97 </span>
<span class="lineno">   98 </span>instance WithFunctions (BusNetwork tag v x t) (F v x) where
<span class="lineno">   99 </span>    <span class="decl"><span class="istickedoff">functions BusNetwork{bnRemains, bnBinded} = bnRemains ++ concat (M.elems bnBinded)</span></span>
<span class="lineno">  100 </span>
<span class="lineno">  101 </span>instance (UnitTag tag, VarValTime v x t) =&gt; DataflowProblem (BusNetwork tag v x t) tag v t where
<span class="lineno">  102 </span>    <span class="decl"><span class="istickedoff">dataflowOptions BusNetwork{bnPus, bnProcess} =</span>
<span class="lineno">  103 </span><span class="spaces">        </span><span class="istickedoff">let sources =</span>
<span class="lineno">  104 </span><span class="spaces">                </span><span class="istickedoff">concatMap</span>
<span class="lineno">  105 </span><span class="spaces">                    </span><span class="istickedoff">(\(tag, pu) -&gt; map (\ep -&gt; (tag, ep)) $ filter isSource $ endpointOptions pu)</span>
<span class="lineno">  106 </span><span class="spaces">                    </span><span class="istickedoff">$ M.assocs bnPus</span>
<span class="lineno">  107 </span><span class="spaces">            </span><span class="istickedoff">targets =</span>
<span class="lineno">  108 </span><span class="spaces">                </span><span class="istickedoff">M.fromList $</span>
<span class="lineno">  109 </span><span class="spaces">                    </span><span class="istickedoff">concatMap</span>
<span class="lineno">  110 </span><span class="spaces">                        </span><span class="istickedoff">( \(tag, pu) -&gt;</span>
<span class="lineno">  111 </span><span class="spaces">                            </span><span class="istickedoff">concatMap (\ep -&gt; map (,(tag, ep)) $ S.elems $ variables ep) $</span>
<span class="lineno">  112 </span><span class="spaces">                                </span><span class="istickedoff">filter isTarget $ endpointOptions pu</span>
<span class="lineno">  113 </span><span class="spaces">                        </span><span class="istickedoff">)</span>
<span class="lineno">  114 </span><span class="spaces">                        </span><span class="istickedoff">$ M.assocs bnPus</span>
<span class="lineno">  115 </span><span class="spaces">         </span><span class="istickedoff">in filter (not . null . dfTargets) $</span>
<span class="lineno">  116 </span><span class="spaces">                </span><span class="istickedoff">concatMap</span>
<span class="lineno">  117 </span><span class="spaces">                    </span><span class="istickedoff">( \(src, sEndpoint) -&gt;</span>
<span class="lineno">  118 </span><span class="spaces">                        </span><span class="istickedoff">let dfSource = (src, netConstrain sEndpoint)</span>
<span class="lineno">  119 </span><span class="spaces">                            </span><span class="istickedoff">-- collsion example (can not be sended at the same time):</span>
<span class="lineno">  120 </span><span class="spaces">                            </span><span class="istickedoff">-- fram1</span>
<span class="lineno">  121 </span><span class="spaces">                            </span><span class="istickedoff">--   x1 -&gt; accum</span>
<span class="lineno">  122 </span><span class="spaces">                            </span><span class="istickedoff">--   x2 -&gt; accum</span>
<span class="lineno">  123 </span><span class="spaces">                            </span><span class="istickedoff">(hold, sendWithColisions) =</span>
<span class="lineno">  124 </span><span class="spaces">                                </span><span class="istickedoff">L.partition (\v -&gt; isNothing $ targets M.!? v) $</span>
<span class="lineno">  125 </span><span class="spaces">                                    </span><span class="istickedoff">S.elems $ variables sEndpoint</span>
<span class="lineno">  126 </span><span class="spaces">                            </span><span class="istickedoff">sends =</span>
<span class="lineno">  127 </span><span class="spaces">                                </span><span class="istickedoff">sequence $</span>
<span class="lineno">  128 </span><span class="spaces">                                    </span><span class="istickedoff">M.elems $</span>
<span class="lineno">  129 </span><span class="spaces">                                        </span><span class="istickedoff">foldr</span>
<span class="lineno">  130 </span><span class="spaces">                                            </span><span class="istickedoff">(\v -&gt; M.alter (Just . maybe [v] (v :)) (fst $ targets M.! v))</span>
<span class="lineno">  131 </span><span class="spaces">                                            </span><span class="istickedoff">def</span>
<span class="lineno">  132 </span><span class="spaces">                                            </span><span class="istickedoff">sendWithColisions</span>
<span class="lineno">  133 </span><span class="spaces">                         </span><span class="istickedoff">in map</span>
<span class="lineno">  134 </span><span class="spaces">                                </span><span class="istickedoff">( \send -&gt;</span>
<span class="lineno">  135 </span><span class="spaces">                                    </span><span class="istickedoff">DataflowSt</span>
<span class="lineno">  136 </span><span class="spaces">                                        </span><span class="istickedoff">{ dfSource</span>
<span class="lineno">  137 </span><span class="spaces">                                        </span><span class="istickedoff">, dfTargets =</span>
<span class="lineno">  138 </span><span class="spaces">                                            </span><span class="istickedoff">mapMaybe</span>
<span class="lineno">  139 </span><span class="spaces">                                                </span><span class="istickedoff">(\v -&gt; fmap (second netConstrain) (targets M.!? v))</span>
<span class="lineno">  140 </span><span class="spaces">                                                </span><span class="istickedoff">$ send ++ hold</span>
<span class="lineno">  141 </span><span class="spaces">                                        </span><span class="istickedoff">}</span>
<span class="lineno">  142 </span><span class="spaces">                                </span><span class="istickedoff">)</span>
<span class="lineno">  143 </span><span class="spaces">                                </span><span class="istickedoff">sends</span>
<span class="lineno">  144 </span><span class="spaces">                    </span><span class="istickedoff">)</span>
<span class="lineno">  145 </span><span class="spaces">                    </span><span class="istickedoff">sources</span>
<span class="lineno">  146 </span><span class="spaces">        </span><span class="istickedoff">where</span>
<span class="lineno">  147 </span><span class="spaces">            </span><span class="istickedoff">netConstrain =</span>
<span class="lineno">  148 </span><span class="spaces">                </span><span class="istickedoff">updAt $ \at@TimeConstraint{tcAvailable} -&gt;</span>
<span class="lineno">  149 </span><span class="spaces">                    </span><span class="istickedoff">let a = max (nextTick bnProcess) $ inf tcAvailable</span>
<span class="lineno">  150 </span><span class="spaces">                        </span><span class="istickedoff">b = sup tcAvailable</span>
<span class="lineno">  151 </span><span class="spaces">                     </span><span class="istickedoff">in at{tcAvailable = a ... b}</span></span>
<span class="lineno">  152 </span>
<span class="lineno">  153 </span>    <span class="decl"><span class="istickedoff">dataflowDecision bn@BusNetwork{bnProcess, bnPus} DataflowSt{dfSource = (srcTitle, src), dfTargets}</span>
<span class="lineno">  154 </span><span class="spaces">        </span><span class="istickedoff">| <span class="tickonlyfalse">nextTick bnProcess &gt; inf (epAt src)</span> =</span>
<span class="lineno">  155 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">error $ &quot;BusNetwork wraping time! Time: &quot; ++ show (nextTick bnProcess) ++ &quot; Act start at: &quot; ++ show src</span></span>
<span class="lineno">  156 </span><span class="spaces">        </span><span class="istickedoff">| <span class="tickonlytrue">otherwise</span> =</span>
<span class="lineno">  157 </span><span class="spaces">            </span><span class="istickedoff">let srcStart = inf $ epAt src</span>
<span class="lineno">  158 </span><span class="spaces">                </span><span class="istickedoff">srcDuration = maximum $ map ((\EndpointSt{epAt} -&gt; (inf epAt - srcStart) + I.width epAt) . snd) dfTargets</span>
<span class="lineno">  159 </span><span class="spaces">                </span><span class="istickedoff">srcEnd = srcStart + srcDuration</span>
<span class="lineno">  160 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  161 </span><span class="spaces">                </span><span class="istickedoff">subDecisions =</span>
<span class="lineno">  162 </span><span class="spaces">                    </span><span class="istickedoff">(srcTitle, EndpointSt (Source $ unionsMap (variables . snd) dfTargets) (epAt src)) : dfTargets</span>
<span class="lineno">  163 </span><span class="spaces">             </span><span class="istickedoff">in bn</span>
<span class="lineno">  164 </span><span class="spaces">                    </span><span class="istickedoff">{ bnPus = foldl applyDecision bnPus subDecisions</span>
<span class="lineno">  165 </span><span class="spaces">                    </span><span class="istickedoff">, bnProcess = execScheduleWithProcess <span class="nottickedoff">bn</span> bnProcess $ do</span>
<span class="lineno">  166 </span><span class="spaces">                        </span><span class="istickedoff">mapM_</span>
<span class="lineno">  167 </span><span class="spaces">                            </span><span class="istickedoff">( \(targetTitle, ep) -&gt;</span>
<span class="lineno">  168 </span><span class="spaces">                                </span><span class="istickedoff">scheduleInstructionUnsafe</span>
<span class="lineno">  169 </span><span class="spaces">                                    </span><span class="istickedoff">(srcStart ... srcEnd)</span>
<span class="lineno">  170 </span><span class="spaces">                                    </span><span class="istickedoff">(Transport (oneOf $ variables ep) srcTitle targetTitle :: Instruction (BusNetwork tag v x t))</span>
<span class="lineno">  171 </span><span class="spaces">                            </span><span class="istickedoff">)</span>
<span class="lineno">  172 </span><span class="spaces">                            </span><span class="istickedoff">dfTargets</span>
<span class="lineno">  173 </span><span class="spaces">                    </span><span class="istickedoff">}</span>
<span class="lineno">  174 </span><span class="spaces">        </span><span class="istickedoff">where</span>
<span class="lineno">  175 </span><span class="spaces">            </span><span class="istickedoff">applyDecision pus (trgTitle, d') = M.adjust (`endpointDecision` d') trgTitle pus</span></span>
<span class="lineno">  176 </span>
<span class="lineno">  177 </span>instance (UnitTag tag, VarValTime v x t) =&gt; ProcessorUnit (BusNetwork tag v x t) v x t where
<span class="lineno">  178 </span>    <span class="decl"><span class="istickedoff">tryBind f net@BusNetwork{bnRemains, bnPus}</span>
<span class="lineno">  179 </span><span class="spaces">        </span><span class="istickedoff">| <span class="tickonlytrue">any (allowToProcess f) $ M.elems bnPus</span> =</span>
<span class="lineno">  180 </span><span class="spaces">            </span><span class="istickedoff">Right net{bnRemains = f : bnRemains}</span>
<span class="lineno">  181 </span><span class="spaces">    </span><span class="istickedoff">tryBind f BusNetwork{bnPus} =</span>
<span class="lineno">  182 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">Left [i|All sub process units reject the functional block: #{ f }; rejects: #{ rejects }|]</span></span>
<span class="lineno">  183 </span><span class="spaces">        </span><span class="istickedoff">where</span>
<span class="lineno">  184 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">rejects = T.intercalate &quot;; &quot; $ map showReject $ M.assocs bnPus</span></span>
<span class="lineno">  185 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">showReject (tag, pu) | Left err &lt;- tryBind f pu = [i|[#{ toString tag }]: #{ err }&quot;|]</span></span>
<span class="lineno">  186 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">showReject (tag, _) = [i|[#{ toString tag }]: undefined&quot;|]</span></span></span>
<span class="lineno">  187 </span>
<span class="lineno">  188 </span>    <span class="decl"><span class="istickedoff">process net@BusNetwork{bnProcess, bnPus} =</span>
<span class="lineno">  189 </span><span class="spaces">        </span><span class="istickedoff">let v2transportStepKey =</span>
<span class="lineno">  190 </span><span class="spaces">                </span><span class="istickedoff">M.fromList</span>
<span class="lineno">  191 </span><span class="spaces">                    </span><span class="istickedoff">[ (v, pID)</span>
<span class="lineno">  192 </span><span class="spaces">                    </span><span class="istickedoff">| Step{pID, pDesc} &lt;- steps bnProcess</span>
<span class="lineno">  193 </span><span class="spaces">                    </span><span class="istickedoff">, isInstruction pDesc</span>
<span class="lineno">  194 </span><span class="spaces">                    </span><span class="istickedoff">, v &lt;- case pDesc of</span>
<span class="lineno">  195 </span><span class="spaces">                        </span><span class="istickedoff">(InstructionStep ins) | Just (Transport var _ _) &lt;- castInstruction <span class="nottickedoff">net</span> ins -&gt; [var]</span>
<span class="lineno">  196 </span><span class="spaces">                        </span><span class="istickedoff">_ -&gt; <span class="nottickedoff">[]</span></span>
<span class="lineno">  197 </span><span class="spaces">                    </span><span class="istickedoff">]</span>
<span class="lineno">  198 </span><span class="spaces">            </span><span class="istickedoff">wholeProcess = execScheduleWithProcess <span class="nottickedoff">net</span> bnProcess $ do</span>
<span class="lineno">  199 </span><span class="spaces">                </span><span class="istickedoff">mapM_ (uncurry includeNestedProcess) $ L.sortOn fst $ M.assocs bnPus</span>
<span class="lineno">  200 </span><span class="spaces">                </span><span class="istickedoff">Process{steps} &lt;- getProcessSlice</span>
<span class="lineno">  201 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  202 </span><span class="spaces">                </span><span class="istickedoff">-- Vertical relations between Transport and Endpoint</span>
<span class="lineno">  203 </span><span class="spaces">                </span><span class="istickedoff">let enpointStepKeyVars =</span>
<span class="lineno">  204 </span><span class="spaces">                        </span><span class="istickedoff">concatMap</span>
<span class="lineno">  205 </span><span class="spaces">                            </span><span class="istickedoff">( \Step{pID, pDesc} -&gt;</span>
<span class="lineno">  206 </span><span class="spaces">                                </span><span class="istickedoff">case pDesc of</span>
<span class="lineno">  207 </span><span class="spaces">                                    </span><span class="istickedoff">NestedStep{nStep = Step{pDesc = EndpointRoleStep role}} -&gt;</span>
<span class="lineno">  208 </span><span class="spaces">                                        </span><span class="istickedoff">zip (repeat <span class="nottickedoff">pID</span>) $ S.elems $ variables role</span>
<span class="lineno">  209 </span><span class="spaces">                                    </span><span class="istickedoff">_ -&gt; []</span>
<span class="lineno">  210 </span><span class="spaces">                            </span><span class="istickedoff">)</span>
<span class="lineno">  211 </span><span class="spaces">                            </span><span class="istickedoff">steps</span>
<span class="lineno">  212 </span><span class="spaces">                </span><span class="istickedoff">mapM_</span>
<span class="lineno">  213 </span><span class="spaces">                    </span><span class="istickedoff">( \(epKey, v) -&gt;</span>
<span class="lineno">  214 </span><span class="spaces">                        </span><span class="istickedoff">when (v `M.member` v2transportStepKey) $</span>
<span class="lineno">  215 </span><span class="spaces">                            </span><span class="istickedoff">establishVerticalRelation <span class="nottickedoff">(v2transportStepKey M.! v)</span> <span class="nottickedoff">epKey</span></span>
<span class="lineno">  216 </span><span class="spaces">                    </span><span class="istickedoff">)</span>
<span class="lineno">  217 </span><span class="spaces">                    </span><span class="istickedoff">enpointStepKeyVars</span>
<span class="lineno">  218 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  219 </span><span class="spaces">                </span><span class="istickedoff">-- Vertical relations between FB and Transport</span>
<span class="lineno">  220 </span><span class="spaces">                </span><span class="istickedoff">mapM_</span>
<span class="lineno">  221 </span><span class="spaces">                    </span><span class="istickedoff">( \Step{pID, pDesc = NestedStep{nStep = Step{pDesc = FStep f}}} -&gt;</span>
<span class="lineno">  222 </span><span class="spaces">                        </span><span class="istickedoff">mapM_</span>
<span class="lineno">  223 </span><span class="spaces">                            </span><span class="istickedoff">( \v -&gt;</span>
<span class="lineno">  224 </span><span class="spaces">                                </span><span class="istickedoff">when (v `M.member` v2transportStepKey) $</span>
<span class="lineno">  225 </span><span class="spaces">                                    </span><span class="istickedoff">establishVerticalRelation <span class="nottickedoff">pID</span> <span class="nottickedoff">(v2transportStepKey M.! v)</span></span>
<span class="lineno">  226 </span><span class="spaces">                            </span><span class="istickedoff">)</span>
<span class="lineno">  227 </span><span class="spaces">                            </span><span class="istickedoff">$ variables f</span>
<span class="lineno">  228 </span><span class="spaces">                    </span><span class="istickedoff">)</span>
<span class="lineno">  229 </span><span class="spaces">                    </span><span class="istickedoff">$ filter isFB steps</span>
<span class="lineno">  230 </span><span class="spaces">         </span><span class="istickedoff">in wholeProcess</span>
<span class="lineno">  231 </span><span class="spaces">        </span><span class="istickedoff">where</span>
<span class="lineno">  232 </span><span class="spaces">            </span><span class="istickedoff">includeNestedProcess tag pu = do</span>
<span class="lineno">  233 </span><span class="spaces">                </span><span class="istickedoff">let Process{steps, relations} = process pu</span>
<span class="lineno">  234 </span><span class="spaces">                </span><span class="istickedoff">pu2netKey &lt;-</span>
<span class="lineno">  235 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff">M.fromList</span></span>
<span class="lineno">  236 </span><span class="spaces">                        </span><span class="istickedoff">&lt;$&gt; mapM</span>
<span class="lineno">  237 </span><span class="spaces">                            </span><span class="istickedoff">( \step@Step{pID} -&gt; do</span>
<span class="lineno">  238 </span><span class="spaces">                                </span><span class="istickedoff">pID' &lt;- scheduleNestedStep tag step</span>
<span class="lineno">  239 </span><span class="spaces">                                </span><span class="istickedoff">return <span class="nottickedoff">(pID, pID')</span></span>
<span class="lineno">  240 </span><span class="spaces">                            </span><span class="istickedoff">)</span>
<span class="lineno">  241 </span><span class="spaces">                            </span><span class="istickedoff">steps</span>
<span class="lineno">  242 </span><span class="spaces">                </span><span class="istickedoff">mapM_ (\(Vertical h l) -&gt; establishVerticalRelation <span class="nottickedoff">(pu2netKey M.! h)</span> <span class="nottickedoff">(pu2netKey M.! l)</span>) relations</span></span>
<span class="lineno">  243 </span>
<span class="lineno">  244 </span>instance Controllable (BusNetwork tag v x t) where
<span class="lineno">  245 </span>    data Instruction (BusNetwork tag v x t)
<span class="lineno">  246 </span>        = Transport v tag tag
<span class="lineno">  247 </span>        deriving (Typeable)
<span class="lineno">  248 </span>
<span class="lineno">  249 </span>    data Microcode (BusNetwork tag v x t)
<span class="lineno">  250 </span>        = BusNetworkMC (M.Map SignalTag SignalValue)
<span class="lineno">  251 </span>
<span class="lineno">  252 </span>    -- Right now, BusNetwork don't have external control (exclude rst signal and some hacks). All
<span class="lineno">  253 </span>    -- signals starts and ends inside network unit.
<span class="lineno">  254 </span>    <span class="decl"><span class="nottickedoff">zipSignalTagsAndValues BusNetworkPorts BusNetworkMC{} = []</span></span>
<span class="lineno">  255 </span>
<span class="lineno">  256 </span>    <span class="decl"><span class="nottickedoff">usedPortTags _ = error &quot;internal error&quot;</span></span>
<span class="lineno">  257 </span>
<span class="lineno">  258 </span>    <span class="decl"><span class="nottickedoff">takePortTags _ _ = error &quot;internal error&quot;</span></span>
<span class="lineno">  259 </span>
<span class="lineno">  260 </span>instance (ToString tag, Var v) =&gt; Show (Instruction (BusNetwork tag v x t)) where
<span class="lineno">  261 </span>    <span class="decl"><span class="istickedoff">show (Transport v src trg) = &quot;Transport &quot; &lt;&gt; toString v &lt;&gt; &quot; &quot; &lt;&gt; toString src &lt;&gt; &quot; &quot; &lt;&gt; toString trg</span></span>
<span class="lineno">  262 </span>
<span class="lineno">  263 </span>instance {-# OVERLAPS #-} ByTime (BusNetwork tag v x t) t where
<span class="lineno">  264 </span>    <span class="decl"><span class="istickedoff">microcodeAt BusNetwork{..} t =</span>
<span class="lineno">  265 </span><span class="spaces">        </span><span class="istickedoff">BusNetworkMC $ foldl merge initSt $ M.elems bnPus</span>
<span class="lineno">  266 </span><span class="spaces">        </span><span class="istickedoff">where</span>
<span class="lineno">  267 </span><span class="spaces">            </span><span class="istickedoff">initSt = M.fromList $ map (\ins -&gt; (SignalTag $ controlSignalLiteral ins, def)) [0 .. bnSignalBusWidth - 1]</span>
<span class="lineno">  268 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  269 </span><span class="spaces">            </span><span class="istickedoff">merge st PU{unit, uEnv = UnitEnv{ctrlPorts = Just ports}} =</span>
<span class="lineno">  270 </span><span class="spaces">                </span><span class="istickedoff">foldl merge' st $ zipSignalTagsAndValues ports $microcodeAt unit t</span>
<span class="lineno">  271 </span><span class="spaces">            </span><span class="istickedoff">merge _ _ = <span class="nottickedoff">error &quot;internal error&quot;</span></span>
<span class="lineno">  272 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  273 </span><span class="spaces">            </span><span class="istickedoff">merge' st (signalTag, value) = M.adjust (+++ value) signalTag st</span></span>
<span class="lineno">  274 </span>
<span class="lineno">  275 </span>----------------------------------------------------------------------
<span class="lineno">  276 </span>
<span class="lineno">  277 </span>instance
<span class="lineno">  278 </span>    (UnitTag tag, VarValTime v x t) =&gt;
<span class="lineno">  279 </span>    BindProblem (BusNetwork tag v x t) tag v x
<span class="lineno">  280 </span>    where
<span class="lineno">  281 </span>    <span class="decl"><span class="istickedoff">bindOptions BusNetwork{bnRemains, bnPus} = concatMap optionsFor bnRemains</span>
<span class="lineno">  282 </span><span class="spaces">        </span><span class="istickedoff">where</span>
<span class="lineno">  283 </span><span class="spaces">            </span><span class="istickedoff">optionsFor f =</span>
<span class="lineno">  284 </span><span class="spaces">                </span><span class="istickedoff">[ Bind f puTitle</span>
<span class="lineno">  285 </span><span class="spaces">                </span><span class="istickedoff">| (puTitle, pu) &lt;- M.assocs bnPus</span>
<span class="lineno">  286 </span><span class="spaces">                </span><span class="istickedoff">, allowToProcess f pu</span>
<span class="lineno">  287 </span><span class="spaces">                </span><span class="istickedoff">]</span></span>
<span class="lineno">  288 </span>
<span class="lineno">  289 </span>    <span class="decl"><span class="istickedoff">bindDecision bn@BusNetwork{bnProcess, bnPus, bnBinded, bnRemains} (Bind f tag) =</span>
<span class="lineno">  290 </span><span class="spaces">        </span><span class="istickedoff">bn</span>
<span class="lineno">  291 </span><span class="spaces">            </span><span class="istickedoff">{ bnPus = M.adjust (bind f) tag bnPus</span>
<span class="lineno">  292 </span><span class="spaces">            </span><span class="istickedoff">, bnBinded = registerBinding tag f bnBinded</span>
<span class="lineno">  293 </span><span class="spaces">            </span><span class="istickedoff">, bnProcess = execScheduleWithProcess <span class="nottickedoff">bn</span> bnProcess $ scheduleFunctionBind f</span>
<span class="lineno">  294 </span><span class="spaces">            </span><span class="istickedoff">, bnRemains = filter (/= f) bnRemains</span>
<span class="lineno">  295 </span><span class="spaces">            </span><span class="istickedoff">}</span></span>
<span class="lineno">  296 </span>
<span class="lineno">  297 </span>instance (UnitTag tag, VarValTime v x t) =&gt; BreakLoopProblem (BusNetwork tag v x t) v x where
<span class="lineno">  298 </span>    <span class="decl"><span class="istickedoff">breakLoopOptions BusNetwork{bnPus} = concatMap breakLoopOptions $ M.elems bnPus</span></span>
<span class="lineno">  299 </span>
<span class="lineno">  300 </span>    <span class="decl"><span class="istickedoff">breakLoopDecision bn@BusNetwork{bnBinded, bnPus} bl@BreakLoop{} =</span>
<span class="lineno">  301 </span><span class="spaces">        </span><span class="istickedoff">let Just (puTag, bindedToPU) = L.find (elem (recLoop bl) . snd) $ M.assocs bnBinded</span>
<span class="lineno">  302 </span><span class="spaces">            </span><span class="istickedoff">bindedToPU' = recLoopIn bl : recLoopOut bl : (bindedToPU L.\\ [recLoop bl])</span>
<span class="lineno">  303 </span><span class="spaces">         </span><span class="istickedoff">in bn</span>
<span class="lineno">  304 </span><span class="spaces">                </span><span class="istickedoff">{ bnPus = M.adjust (`breakLoopDecision` bl) puTag bnPus</span>
<span class="lineno">  305 </span><span class="spaces">                </span><span class="istickedoff">, bnBinded = M.insert puTag bindedToPU' bnBinded</span>
<span class="lineno">  306 </span><span class="spaces">                </span><span class="istickedoff">}</span></span>
<span class="lineno">  307 </span>
<span class="lineno">  308 </span>instance (VarValTime v x t) =&gt; OptimizeAccumProblem (BusNetwork tag v x t) v x where
<span class="lineno">  309 </span>    <span class="decl"><span class="istickedoff">optimizeAccumOptions BusNetwork{bnRemains} = optimizeAccumOptions bnRemains</span></span>
<span class="lineno">  310 </span>
<span class="lineno">  311 </span>    <span class="decl"><span class="istickedoff">optimizeAccumDecision bn@BusNetwork{bnRemains} oa@OptimizeAccum{} =</span>
<span class="lineno">  312 </span><span class="spaces">        </span><span class="istickedoff">bn{bnRemains = optimizeAccumDecision bnRemains oa}</span></span>
<span class="lineno">  313 </span>
<span class="lineno">  314 </span>instance (VarValTime v x t) =&gt; ConstantFoldingProblem (BusNetwork tag v x t) v x where
<span class="lineno">  315 </span>    <span class="decl"><span class="istickedoff">constantFoldingOptions BusNetwork{bnRemains} = constantFoldingOptions bnRemains</span></span>
<span class="lineno">  316 </span>
<span class="lineno">  317 </span>    <span class="decl"><span class="istickedoff">constantFoldingDecision bn@BusNetwork{bnRemains} cf@ConstantFolding{} =</span>
<span class="lineno">  318 </span><span class="spaces">        </span><span class="istickedoff">bn{bnRemains = constantFoldingDecision bnRemains cf}</span></span>
<span class="lineno">  319 </span>
<span class="lineno">  320 </span>instance (UnitTag tag, VarValTime v x t) =&gt; ResolveDeadlockProblem (BusNetwork tag v x t) v x where
<span class="lineno">  321 </span>    <span class="decl"><span class="istickedoff">resolveDeadlockOptions bn@BusNetwork{bnPus, bnBinded} =</span>
<span class="lineno">  322 </span><span class="spaces">        </span><span class="istickedoff">let prepareResolve :: S.Set v -&gt; [ResolveDeadlock v x]</span>
<span class="lineno">  323 </span><span class="spaces">            </span><span class="istickedoff">prepareResolve =</span>
<span class="lineno">  324 </span><span class="spaces">                </span><span class="istickedoff">map resolveDeadlock</span>
<span class="lineno">  325 </span><span class="spaces">                    </span><span class="istickedoff">. S.elems</span>
<span class="lineno">  326 </span><span class="spaces">                    </span><span class="istickedoff">. S.filter (not . S.null)</span>
<span class="lineno">  327 </span><span class="spaces">                    </span><span class="istickedoff">. ( \lockedVs -&gt;</span>
<span class="lineno">  328 </span><span class="spaces">                            </span><span class="istickedoff">if S.null lockedVs</span>
<span class="lineno">  329 </span><span class="spaces">                                </span><span class="istickedoff">then S.empty</span>
<span class="lineno">  330 </span><span class="spaces">                                </span><span class="istickedoff">else S.filter (not . (lockedVs `S.disjoint`)) $ S.powerSet (var2endpointRole M.! oneOf lockedVs)</span>
<span class="lineno">  331 </span><span class="spaces">                      </span><span class="istickedoff">)</span>
<span class="lineno">  332 </span><span class="spaces">                    </span><span class="istickedoff">. S.filter (isBufferRepetionOK maxBufferStack)</span>
<span class="lineno">  333 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  334 </span><span class="spaces">            </span><span class="istickedoff">isBufferRepetionOK 0 _ = <span class="nottickedoff">False</span></span>
<span class="lineno">  335 </span><span class="spaces">            </span><span class="istickedoff">isBufferRepetionOK n v</span>
<span class="lineno">  336 </span><span class="spaces">                </span><span class="istickedoff">| <span class="tickonlytrue">bufferSuffix v `S.notMember` variables bn</span> = True</span>
<span class="lineno">  337 </span><span class="spaces">                </span><span class="istickedoff">| <span class="nottickedoff">otherwise</span> = <span class="nottickedoff">isBufferRepetionOK (n -1) (bufferSuffix v)</span></span>
<span class="lineno">  338 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  339 </span><span class="spaces">            </span><span class="istickedoff">selfSending =</span>
<span class="lineno">  340 </span><span class="spaces">                </span><span class="istickedoff">concatMap</span>
<span class="lineno">  341 </span><span class="spaces">                    </span><span class="istickedoff">(\(tag, fs) -&gt; prepareResolve (unionsMap inputs fs `S.intersection` puOutputs tag))</span>
<span class="lineno">  342 </span><span class="spaces">                    </span><span class="istickedoff">$ M.assocs bnBinded</span>
<span class="lineno">  343 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  344 </span><span class="spaces">            </span><span class="istickedoff">allPULocks = map (second locks) $ M.assocs bnPus</span>
<span class="lineno">  345 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  346 </span><span class="spaces">            </span><span class="istickedoff">resolveLocks =</span>
<span class="lineno">  347 </span><span class="spaces">                </span><span class="istickedoff">concat</span>
<span class="lineno">  348 </span><span class="spaces">                    </span><span class="istickedoff">[ prepareResolve $ S.singleton lockBy</span>
<span class="lineno">  349 </span><span class="spaces">                    </span><span class="istickedoff">| (tag, ls) &lt;- allPULocks</span>
<span class="lineno">  350 </span><span class="spaces">                    </span><span class="istickedoff">, Lock{lockBy, locked} &lt;- ls</span>
<span class="lineno">  351 </span><span class="spaces">                    </span><span class="istickedoff">, lockBy `S.member` maybeSended</span>
<span class="lineno">  352 </span><span class="spaces">                    </span><span class="istickedoff">, let reversedLock = Lock{lockBy = locked, locked = lockBy}</span>
<span class="lineno">  353 </span><span class="spaces">                    </span><span class="istickedoff">, any (\(t, puLocks) -&gt; tag /= t &amp;&amp; reversedLock `elem` puLocks) allPULocks</span>
<span class="lineno">  354 </span><span class="spaces">                    </span><span class="istickedoff">]</span>
<span class="lineno">  355 </span><span class="spaces">         </span><span class="istickedoff">in L.nub $ selfSending ++ resolveLocks</span>
<span class="lineno">  356 </span><span class="spaces">        </span><span class="istickedoff">where</span>
<span class="lineno">  357 </span><span class="spaces">            </span><span class="istickedoff">endPointRoles = M.map (\pu -&gt; map epRole $ endpointOptions pu) bnPus</span>
<span class="lineno">  358 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  359 </span><span class="spaces">            </span><span class="istickedoff">puOutputs tag =</span>
<span class="lineno">  360 </span><span class="spaces">                </span><span class="istickedoff">unionsMap variables $</span>
<span class="lineno">  361 </span><span class="spaces">                    </span><span class="istickedoff">filter (\case Source{} -&gt; True; _ -&gt; False) $ endPointRoles M.! tag</span>
<span class="lineno">  362 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  363 </span><span class="spaces">            </span><span class="istickedoff">var2endpointRole =</span>
<span class="lineno">  364 </span><span class="spaces">                </span><span class="istickedoff">M.fromList $</span>
<span class="lineno">  365 </span><span class="spaces">                    </span><span class="istickedoff">concatMap</span>
<span class="lineno">  366 </span><span class="spaces">                        </span><span class="istickedoff">( \case</span>
<span class="lineno">  367 </span><span class="spaces">                            </span><span class="istickedoff">(Source vs) -&gt; [(v, vs) | v &lt;- S.elems vs]</span>
<span class="lineno">  368 </span><span class="spaces">                            </span><span class="istickedoff">(Target v) -&gt; [(v, S.singleton v)]</span>
<span class="lineno">  369 </span><span class="spaces">                        </span><span class="istickedoff">)</span>
<span class="lineno">  370 </span><span class="spaces">                        </span><span class="istickedoff">$ concat $ M.elems endPointRoles</span>
<span class="lineno">  371 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  372 </span><span class="spaces">            </span><span class="istickedoff">maybeSended = M.keysSet var2endpointRole</span></span>
<span class="lineno">  373 </span>
<span class="lineno">  374 </span>    <span class="decl"><span class="istickedoff">resolveDeadlockDecision bn@BusNetwork{bnRemains, bnBinded, bnPus} ResolveDeadlock{newBuffer, changeset} =</span>
<span class="lineno">  375 </span><span class="spaces">        </span><span class="istickedoff">let Just (tag, _) =</span>
<span class="lineno">  376 </span><span class="spaces">                </span><span class="istickedoff">L.find</span>
<span class="lineno">  377 </span><span class="spaces">                    </span><span class="istickedoff">(\(_, f) -&gt; not $ null $ S.intersection (outputs newBuffer) $ unionsMap outputs f)</span>
<span class="lineno">  378 </span><span class="spaces">                    </span><span class="istickedoff">$ M.assocs bnBinded</span>
<span class="lineno">  379 </span><span class="spaces">         </span><span class="istickedoff">in bn</span>
<span class="lineno">  380 </span><span class="spaces">                </span><span class="istickedoff">{ bnRemains = newBuffer : patch changeset bnRemains</span>
<span class="lineno">  381 </span><span class="spaces">                </span><span class="istickedoff">, bnPus = M.adjust (patch changeset) tag bnPus</span>
<span class="lineno">  382 </span><span class="spaces">                </span><span class="istickedoff">, bnBinded = M.map (patch changeset) bnBinded</span>
<span class="lineno">  383 </span><span class="spaces">                </span><span class="istickedoff">}</span></span>
<span class="lineno">  384 </span>
<span class="lineno">  385 </span>--------------------------------------------------------------------------
<span class="lineno">  386 </span>
<span class="lineno">  387 </span><span class="decl"><span class="istickedoff">controlSignalLiteral ix = [i|control_bus[#{ ix }]|]</span></span>
<span class="lineno">  388 </span>
<span class="lineno">  389 </span>-- |Add binding to Map tag [F v x] dict
<span class="lineno">  390 </span><span class="decl"><span class="istickedoff">registerBinding tag f dict =</span>
<span class="lineno">  391 </span><span class="spaces">    </span><span class="istickedoff">M.alter (maybe (Just [f]) (Just . (f :))) tag dict</span></span>
<span class="lineno">  392 </span>
<span class="lineno">  393 </span><span class="decl"><span class="istickedoff">programTicks bn = [-1 .. nextTick bn]</span></span>
<span class="lineno">  394 </span>
<span class="lineno">  395 </span><span class="decl"><span class="istickedoff">bnExternalPorts pus =</span>
<span class="lineno">  396 </span><span class="spaces">    </span><span class="istickedoff">M.assocs $</span>
<span class="lineno">  397 </span><span class="spaces">        </span><span class="istickedoff">M.map</span>
<span class="lineno">  398 </span><span class="spaces">            </span><span class="istickedoff">( \pu -&gt;</span>
<span class="lineno">  399 </span><span class="spaces">                </span><span class="istickedoff">( map inputPortTag $ S.toList $ puInputPorts pu</span>
<span class="lineno">  400 </span><span class="spaces">                </span><span class="istickedoff">, map outputPortTag $ S.toList $ puOutputPorts pu</span>
<span class="lineno">  401 </span><span class="spaces">                </span><span class="istickedoff">, map <span class="nottickedoff">inoutPortTag</span> $ S.toList $ puInOutPorts pu</span>
<span class="lineno">  402 </span><span class="spaces">                </span><span class="istickedoff">)</span>
<span class="lineno">  403 </span><span class="spaces">            </span><span class="istickedoff">)</span>
<span class="lineno">  404 </span><span class="spaces">            </span><span class="istickedoff">pus</span></span>
<span class="lineno">  405 </span>
<span class="lineno">  406 </span><span class="decl"><span class="istickedoff">externalPortsDecl ports =</span>
<span class="lineno">  407 </span><span class="spaces">    </span><span class="istickedoff">concatMap</span>
<span class="lineno">  408 </span><span class="spaces">        </span><span class="istickedoff">( \(tag, (is, os, ios)) -&gt;</span>
<span class="lineno">  409 </span><span class="spaces">            </span><span class="istickedoff">concat</span>
<span class="lineno">  410 </span><span class="spaces">                </span><span class="istickedoff">[ [&quot;// external ports for: &quot; &lt;&gt; toText tag]</span>
<span class="lineno">  411 </span><span class="spaces">                </span><span class="istickedoff">, map (&quot;, input &quot; &lt;&gt;) is</span>
<span class="lineno">  412 </span><span class="spaces">                </span><span class="istickedoff">, map (&quot;, output &quot; &lt;&gt;) os</span>
<span class="lineno">  413 </span><span class="spaces">                </span><span class="istickedoff">, map <span class="nottickedoff">(&quot;, inout &quot; &lt;&gt;)</span> ios</span>
<span class="lineno">  414 </span><span class="spaces">                </span><span class="istickedoff">]</span>
<span class="lineno">  415 </span><span class="spaces">        </span><span class="istickedoff">)</span>
<span class="lineno">  416 </span><span class="spaces">        </span><span class="istickedoff">ports</span></span>
<span class="lineno">  417 </span>
<span class="lineno">  418 </span>instance (UnitTag tag, VarValTime v x t) =&gt; TargetSystemComponent (BusNetwork tag v x t) where
<span class="lineno">  419 </span>    <span class="decl"><span class="istickedoff">moduleName _tag BusNetwork{bnName} = toText bnName</span></span>
<span class="lineno">  420 </span>
<span class="lineno">  421 </span>    <span class="decl"><span class="istickedoff">hardware tag pu@BusNetwork{..} =</span>
<span class="lineno">  422 </span><span class="spaces">        </span><span class="istickedoff">let (instances, valuesRegs) = renderInstance [] [] $ M.assocs bnPus</span>
<span class="lineno">  423 </span><span class="spaces">            </span><span class="istickedoff">mn = moduleName <span class="nottickedoff">tag</span> pu</span>
<span class="lineno">  424 </span><span class="spaces">            </span><span class="istickedoff">iml =</span>
<span class="lineno">  425 </span><span class="spaces">                </span><span class="istickedoff">[__i|<span class="nottickedoff"><span class="istickedoff"></span></span></span>
<span class="lineno">  426 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">module #{ mn } \#</span></span></span>
<span class="lineno">  427 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">( parameter DATA_WIDTH = #{ dataWidth (def :: x) }</span></span></span>
<span class="lineno">  428 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, parameter ATTR_WIDTH = #{ attrWidth (def :: x) }</span></span></span>
<span class="lineno">  429 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">)</span></span></span>
<span class="lineno">  430 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">( input                     clk</span></span></span>
<span class="lineno">  431 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, input                     rst</span></span></span>
<span class="lineno">  432 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, input                     is_drop_allow</span></span></span>
<span class="lineno">  433 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, output                    flag_cycle_begin</span></span></span>
<span class="lineno">  434 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, output                    flag_in_cycle</span></span></span>
<span class="lineno">  435 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, output                    flag_cycle_end</span></span></span>
<span class="lineno">  436 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">#{ nest 4 $ vsep $ map pretty $ externalPortsDecl $ bnExternalPorts bnPus }</span></span></span>
<span class="lineno">  437 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, output              [7:0] debug_status</span></span></span>
<span class="lineno">  438 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, output              [7:0] debug_bus1</span></span></span>
<span class="lineno">  439 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, output              [7:0] debug_bus2</span></span></span>
<span class="lineno">  440 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">);</span></span></span>
<span class="lineno">  441 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span>
<span class="lineno">  442 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">parameter MICROCODE_WIDTH = #{ bnSignalBusWidth };</span></span></span>
<span class="lineno">  443 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span>
<span class="lineno">  444 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">wire start, stop;</span></span></span>
<span class="lineno">  445 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span>
<span class="lineno">  446 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">wire [MICROCODE_WIDTH-1:0] control_bus;</span></span></span>
<span class="lineno">  447 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">wire [DATA_WIDTH-1:0] data_bus;</span></span></span>
<span class="lineno">  448 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">wire [ATTR_WIDTH-1:0] attr_bus;</span></span></span>
<span class="lineno">  449 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span>
<span class="lineno">  450 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">// Debug</span></span></span>
<span class="lineno">  451 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">assign debug_status = { flag_cycle_begin, flag_in_cycle, flag_cycle_end, data_bus[4:0] };</span></span></span>
<span class="lineno">  452 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">assign debug_bus1 = data_bus[7:0];</span></span></span>
<span class="lineno">  453 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">assign debug_bus2 = data_bus[31:24] | data_bus[23:16] | data_bus[15:8] | data_bus[7:0];</span></span></span>
<span class="lineno">  454 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span>
<span class="lineno">  455 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span>
<span class="lineno">  456 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">// Sub module instances</span></span></span>
<span class="lineno">  457 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span>
<span class="lineno">  458 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">pu_simple_control \#</span></span></span>
<span class="lineno">  459 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">( .MICROCODE_WIDTH( MICROCODE_WIDTH )</span></span></span>
<span class="lineno">  460 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .PROGRAM_DUMP( &quot;{{ impl.paths.nest }}/#{ mn }.dump&quot; )</span></span></span>
<span class="lineno">  461 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .MEMORY_SIZE( #{ length $ programTicks pu } ) // 0 - address for nop microcode</span></span></span>
<span class="lineno">  462 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">) control_unit</span></span></span>
<span class="lineno">  463 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">( .clk( clk )</span></span></span>
<span class="lineno">  464 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .rst( rst )</span></span></span>
<span class="lineno">  465 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span>
<span class="lineno">  466 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .signal_cycle_start( #{ isDrowAllowSignal ioSync } || stop )</span></span></span>
<span class="lineno">  467 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span>
<span class="lineno">  468 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .signals_out( control_bus )</span></span></span>
<span class="lineno">  469 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span>
<span class="lineno">  470 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .flag_cycle_begin( flag_cycle_begin )</span></span></span>
<span class="lineno">  471 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .flag_in_cycle( flag_in_cycle )</span></span></span>
<span class="lineno">  472 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .flag_cycle_end( flag_cycle_end )</span></span></span>
<span class="lineno">  473 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">);</span></span></span>
<span class="lineno">  474 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span>
<span class="lineno">  475 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">#{ vsep $ punctuate &quot;\n\n&quot; instances }</span></span></span>
<span class="lineno">  476 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span>
<span class="lineno">  477 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">assign data_bus = #{ T.intercalate &quot; | &quot; $ map snd valuesRegs };</span></span></span>
<span class="lineno">  478 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">assign attr_bus = #{ T.intercalate &quot; | &quot; $ map fst valuesRegs };</span></span></span>
<span class="lineno">  479 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span>
<span class="lineno">  480 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">endmodule</span></span></span>
<span class="lineno">  481 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">|]</span></span></span>
<span class="lineno">  482 </span><span class="spaces">         </span><span class="istickedoff">in Aggregate (Just $ toString mn) $</span>
<span class="lineno">  483 </span><span class="spaces">                </span><span class="istickedoff">[ Immediate (toString $ mn &lt;&gt; &quot;.v&quot;) iml</span>
<span class="lineno">  484 </span><span class="spaces">                </span><span class="istickedoff">, FromLibrary &quot;pu_simple_control.v&quot;</span>
<span class="lineno">  485 </span><span class="spaces">                </span><span class="istickedoff">]</span>
<span class="lineno">  486 </span><span class="spaces">                    </span><span class="istickedoff">&lt;&gt; map (uncurry hardware . first <span class="nottickedoff">toText</span>) (M.assocs bnPus)</span>
<span class="lineno">  487 </span><span class="spaces">        </span><span class="istickedoff">where</span>
<span class="lineno">  488 </span><span class="spaces">            </span><span class="istickedoff">regInstance t =</span>
<span class="lineno">  489 </span><span class="spaces">                </span><span class="istickedoff">[__i|</span>
<span class="lineno">  490 </span><span class="spaces">                    </span><span class="istickedoff">wire [DATA_WIDTH-1:0] #{ t }_data_out;</span>
<span class="lineno">  491 </span><span class="spaces">                    </span><span class="istickedoff">wire [ATTR_WIDTH-1:0] #{ t }_attr_out;</span>
<span class="lineno">  492 </span><span class="spaces">                </span><span class="istickedoff">|]</span>
<span class="lineno">  493 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  494 </span><span class="spaces">            </span><span class="istickedoff">renderInstance insts regs [] = (reverse insts, reverse regs)</span>
<span class="lineno">  495 </span><span class="spaces">            </span><span class="istickedoff">renderInstance insts regs ((t, PU{unit, uEnv}) : xs) =</span>
<span class="lineno">  496 </span><span class="spaces">                </span><span class="istickedoff">let inst = hardwareInstance (toText t) unit uEnv</span>
<span class="lineno">  497 </span><span class="spaces">                    </span><span class="istickedoff">insts' = inst : regInstance (toText t) : insts</span>
<span class="lineno">  498 </span><span class="spaces">                    </span><span class="istickedoff">regs' = (toText t &lt;&gt; &quot;_attr_out&quot;, toText t &lt;&gt; &quot;_data_out&quot;) : regs</span>
<span class="lineno">  499 </span><span class="spaces">                 </span><span class="istickedoff">in renderInstance insts' regs' xs</span></span>
<span class="lineno">  500 </span>
<span class="lineno">  501 </span>    <span class="decl"><span class="istickedoff">software tag pu@BusNetwork{bnProcess = Process{}, ..} =</span>
<span class="lineno">  502 </span><span class="spaces">        </span><span class="istickedoff">let subSW = map (uncurry software . first toText) $ M.assocs bnPus</span>
<span class="lineno">  503 </span><span class="spaces">            </span><span class="istickedoff">sw = [Immediate (toString $ mn &lt;&gt; &quot;.dump&quot;) $ T.pack memoryDump]</span>
<span class="lineno">  504 </span><span class="spaces">         </span><span class="istickedoff">in Aggregate (Just $ toString mn) $ subSW ++ sw</span>
<span class="lineno">  505 </span><span class="spaces">        </span><span class="istickedoff">where</span>
<span class="lineno">  506 </span><span class="spaces">            </span><span class="istickedoff">mn = moduleName <span class="nottickedoff">tag</span> pu</span>
<span class="lineno">  507 </span><span class="spaces">            </span><span class="istickedoff">-- Nop operation sets for all processor units at address 0. It is a</span>
<span class="lineno">  508 </span><span class="spaces">            </span><span class="istickedoff">-- safe state of the processor which is selected when rst signal is</span>
<span class="lineno">  509 </span><span class="spaces">            </span><span class="istickedoff">-- active.</span>
<span class="lineno">  510 </span><span class="spaces">            </span><span class="istickedoff">memoryDump = unlines $ map (values2dump . values . microcodeAt pu) $ programTicks pu</span>
<span class="lineno">  511 </span><span class="spaces">            </span><span class="istickedoff">values (BusNetworkMC arr) =</span>
<span class="lineno">  512 </span><span class="spaces">                </span><span class="istickedoff">reverse $</span>
<span class="lineno">  513 </span><span class="spaces">                    </span><span class="istickedoff">map snd $</span>
<span class="lineno">  514 </span><span class="spaces">                        </span><span class="istickedoff">L.sortOn ((\(Just [ix]) -&gt; read ix :: Int) . matchRegex (mkRegex &quot;([[:digit:]]+)&quot;) . T.unpack . signalTag . fst) $</span>
<span class="lineno">  515 </span><span class="spaces">                            </span><span class="istickedoff">M.assocs arr</span></span>
<span class="lineno">  516 </span>
<span class="lineno">  517 </span>    <span class="decl"><span class="istickedoff">hardwareInstance tag BusNetwork{} UnitEnv{sigRst, sigClk, ioPorts = Just ioPorts}</span>
<span class="lineno">  518 </span><span class="spaces">        </span><span class="istickedoff">| let io2v n = [i|, .#{ n }( #{ n } )|]</span>
<span class="lineno">  519 </span><span class="spaces">              </span><span class="istickedoff">is = map (io2v . inputPortTag) $ S.toList $ inputPorts ioPorts</span>
<span class="lineno">  520 </span><span class="spaces">              </span><span class="istickedoff">os = map (io2v . outputPortTag) $ S.toList $ outputPorts ioPorts =</span>
<span class="lineno">  521 </span><span class="spaces">            </span><span class="istickedoff">[__i|<span class="nottickedoff"><span class="istickedoff"></span></span></span>
<span class="lineno">  522 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">#{ tag } \#</span></span></span>
<span class="lineno">  523 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">( .DATA_WIDTH( #{ dataWidth (def :: x) } )</span></span></span>
<span class="lineno">  524 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .ATTR_WIDTH( #{ attrWidth (def :: x) } )</span></span></span>
<span class="lineno">  525 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">) net</span></span></span>
<span class="lineno">  526 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">( .rst( #{ sigRst } )</span></span></span>
<span class="lineno">  527 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .clk( #{ sigClk } )</span></span></span>
<span class="lineno">  528 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">// inputs:</span></span></span>
<span class="lineno">  529 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">#{ nest 4 $ vsep is }</span></span></span>
<span class="lineno">  530 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">// outputs:</span></span></span>
<span class="lineno">  531 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">#{ nest 4 $ vsep os }</span></span></span>
<span class="lineno">  532 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .debug_status( debug_status ) // FIXME:</span></span></span>
<span class="lineno">  533 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .debug_bus1( debug_bus1 )     // FIXME:</span></span></span>
<span class="lineno">  534 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .debug_bus2( debug_bus2 )     // FIXME:</span></span></span>
<span class="lineno">  535 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .is_drop_allow( rendezvous )  // FIXME:</span></span></span>
<span class="lineno">  536 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">);</span></span></span>
<span class="lineno">  537 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">|]</span></span></span>
<span class="lineno">  538 </span><span class="spaces">    </span><span class="istickedoff">hardwareInstance _title _bn _env =</span>
<span class="lineno">  539 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">error &quot;BusNetwork should be NetworkEnv&quot;</span></span></span>
<span class="lineno">  540 </span>
<span class="lineno">  541 </span>instance Connected (BusNetwork tag v x t) where
<span class="lineno">  542 </span>    data Ports (BusNetwork tag v x t) = BusNetworkPorts
<span class="lineno">  543 </span>        deriving (<span class="decl"><span class="nottickedoff">Show</span></span>)
<span class="lineno">  544 </span>
<span class="lineno">  545 </span>instance IOConnected (BusNetwork tag v x t) where
<span class="lineno">  546 </span>    data IOPorts (BusNetwork tag v x t) = BusNetworkIO
<span class="lineno">  547 </span>        { <span class="istickedoff"><span class="decl"><span class="istickedoff">extInputs</span></span></span> :: S.Set InputPortTag
<span class="lineno">  548 </span>        , <span class="istickedoff"><span class="decl"><span class="istickedoff">extOutputs</span></span></span> :: S.Set OutputPortTag
<span class="lineno">  549 </span>        , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">extInOuts</span></span></span> :: S.Set InoutPortTag
<span class="lineno">  550 </span>        }
<span class="lineno">  551 </span>        deriving (<span class="decl"><span class="nottickedoff">Show</span></span>)
<span class="lineno">  552 </span>    <span class="decl"><span class="istickedoff">inputPorts = extInputs</span></span>
<span class="lineno">  553 </span>    <span class="decl"><span class="istickedoff">outputPorts = extOutputs</span></span>
<span class="lineno">  554 </span>    <span class="decl"><span class="nottickedoff">inoutPorts = extInOuts</span></span>
<span class="lineno">  555 </span>
<span class="lineno">  556 </span>instance (UnitTag tag, VarValTime v x t) =&gt; Testable (BusNetwork tag v x t) v x where
<span class="lineno">  557 </span>    <span class="decl"><span class="istickedoff">testBenchImplementation</span>
<span class="lineno">  558 </span><span class="spaces">        </span><span class="istickedoff">Project</span>
<span class="lineno">  559 </span><span class="spaces">            </span><span class="istickedoff">{ pName</span>
<span class="lineno">  560 </span><span class="spaces">            </span><span class="istickedoff">, pUnit = bn@BusNetwork{bnPus, ioSync, bnName}</span>
<span class="lineno">  561 </span><span class="spaces">            </span><span class="istickedoff">, pTestCntx = pTestCntx@Cntx{cntxProcess, cntxCycleNumber}</span>
<span class="lineno">  562 </span><span class="spaces">            </span><span class="istickedoff">} =</span>
<span class="lineno">  563 </span><span class="spaces">            </span><span class="istickedoff">let testEnv =</span>
<span class="lineno">  564 </span><span class="spaces">                    </span><span class="istickedoff">vsep $</span>
<span class="lineno">  565 </span><span class="spaces">                        </span><span class="istickedoff">mapMaybe</span>
<span class="lineno">  566 </span><span class="spaces">                            </span><span class="istickedoff">( \(tag, PU{unit, uEnv}) -&gt;</span>
<span class="lineno">  567 </span><span class="spaces">                                </span><span class="istickedoff">let tEnv =</span>
<span class="lineno">  568 </span><span class="spaces">                                        </span><span class="istickedoff">TestEnvironment</span>
<span class="lineno">  569 </span><span class="spaces">                                            </span><span class="istickedoff">{ teCntx = pTestCntx</span>
<span class="lineno">  570 </span><span class="spaces">                                            </span><span class="istickedoff">, teComputationDuration = fromEnum $ nextTick bn</span>
<span class="lineno">  571 </span><span class="spaces">                                            </span><span class="istickedoff">}</span>
<span class="lineno">  572 </span><span class="spaces">                                 </span><span class="istickedoff">in testEnvironment (toText tag) unit uEnv tEnv</span>
<span class="lineno">  573 </span><span class="spaces">                            </span><span class="istickedoff">)</span>
<span class="lineno">  574 </span><span class="spaces">                            </span><span class="istickedoff">$ M.assocs bnPus</span>
<span class="lineno">  575 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  576 </span><span class="spaces">                </span><span class="istickedoff">externalPortNames = map pretty $ concatMap ((\(is, os, ios) -&gt; is &lt;&gt; os &lt;&gt; ios) . snd) $ bnExternalPorts bnPus</span>
<span class="lineno">  577 </span><span class="spaces">                </span><span class="istickedoff">externalIO = vsep $ punctuate &quot;, &quot; (&quot;&quot; : map (\p -&gt; [i|.#{ p }( #{ p } )|]) externalPortNames)</span>
<span class="lineno">  578 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  579 </span><span class="spaces">                </span><span class="istickedoff">envInitFlags = map pretty $ mapMaybe (uncurry testEnvironmentInitFlag . first toText) $ M.assocs bnPus</span>
<span class="lineno">  580 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  581 </span><span class="spaces">                </span><span class="istickedoff">tickWithTransfers =</span>
<span class="lineno">  582 </span><span class="spaces">                    </span><span class="istickedoff">map</span>
<span class="lineno">  583 </span><span class="spaces">                        </span><span class="istickedoff">( \(cycleI, cycleCntx) -&gt;</span>
<span class="lineno">  584 </span><span class="spaces">                            </span><span class="istickedoff">map</span>
<span class="lineno">  585 </span><span class="spaces">                                </span><span class="istickedoff">(\t -&gt; (cycleI, t, cntxToTransfer cycleCntx t))</span>
<span class="lineno">  586 </span><span class="spaces">                                </span><span class="istickedoff">[0 .. nextTick bn]</span>
<span class="lineno">  587 </span><span class="spaces">                        </span><span class="istickedoff">)</span>
<span class="lineno">  588 </span><span class="spaces">                        </span><span class="istickedoff">$ zip [0 :: Int ..] $ take cntxCycleNumber cntxProcess</span>
<span class="lineno">  589 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  590 </span><span class="spaces">                </span><span class="istickedoff">assertions = vsep $ map (\cycleTickTransfer -&gt; posedgeCycle &lt;&gt; line &lt;&gt; vsep (map assertion cycleTickTransfer)) tickWithTransfers</span>
<span class="lineno">  591 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  592 </span><span class="spaces">                </span><span class="istickedoff">assertion (cycleI, t, Nothing) =</span>
<span class="lineno">  593 </span><span class="spaces">                    </span><span class="istickedoff">[i|@(posedge clk); traceWithAttr(#{ cycleI }, #{ t }, #{ toString bnName }.data_bus, #{ toString bnName }.attr_bus);|]</span>
<span class="lineno">  594 </span><span class="spaces">                </span><span class="istickedoff">assertion (cycleI, t, Just (v, x)) =</span>
<span class="lineno">  595 </span><span class="spaces">                    </span><span class="istickedoff">[i|@(posedge clk); assertWithAttr(#{ cycleI }, #{ t }, #{ toString bnName }.data_bus, #{ toString bnName }.attr_bus, #{ dataLiteral x }, #{ attrLiteral x }, &quot;#{ toString v }&quot;);|]</span>
<span class="lineno">  596 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  597 </span><span class="spaces">                </span><span class="istickedoff">tbName = moduleName <span class="nottickedoff">pName</span> bn &lt;&gt; &quot;_tb&quot;</span>
<span class="lineno">  598 </span><span class="spaces">             </span><span class="istickedoff">in Aggregate</span>
<span class="lineno">  599 </span><span class="spaces">                    </span><span class="istickedoff">Nothing</span>
<span class="lineno">  600 </span><span class="spaces">                    </span><span class="istickedoff">[ Immediate (toString $ tbName &lt;&gt; &quot;.v&quot;) $</span>
<span class="lineno">  601 </span><span class="spaces">                        </span><span class="istickedoff">doc2text</span>
<span class="lineno">  602 </span><span class="spaces">                            </span><span class="istickedoff">[__i|<span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span></span></span></span></span></span></span>
<span class="lineno">  603 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">`timescale 1 ps / 1 ps</span></span></span></span></span></span></span></span></span>
<span class="lineno">  604 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">module #{ tbName }();</span></span></span></span></span></span></span></span></span>
<span class="lineno">  605 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span></span></span></span></span></span></span>
<span class="lineno">  606 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">/*</span></span></span></span></span></span></span></span></span>
<span class="lineno">  607 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">Functions:</span></span></span></span></span></span></span></span></span>
<span class="lineno">  608 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">#{ indent 4 $ vsep $ map viaShow $ functions bn }</span></span></span></span></span></span></span></span></span>
<span class="lineno">  609 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">*/</span></span></span></span></span></span></span></span></span>
<span class="lineno">  610 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span></span></span></span></span></span></span>
<span class="lineno">  611 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">/*</span></span></span></span></span></span></span></span></span>
<span class="lineno">  612 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">Steps:</span></span></span></span></span></span></span></span></span>
<span class="lineno">  613 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">#{ indent 4 $ vsep $ map viaShow $ reverse $ steps $ process bn }</span></span></span></span></span></span></span></span></span>
<span class="lineno">  614 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">*/</span></span></span></span></span></span></span></span></span>
<span class="lineno">  615 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span></span></span></span></span></span></span>
<span class="lineno">  616 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">// system signals</span></span></span></span></span></span></span></span></span>
<span class="lineno">  617 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">reg clk, rst;</span></span></span></span></span></span></span></span></span>
<span class="lineno">  618 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">wire cycle;</span></span></span></span></span></span></span></span></span>
<span class="lineno">  619 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span></span></span></span></span></span></span>
<span class="lineno">  620 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">// clk and rst generator</span></span></span></span></span></span></span></span></span>
<span class="lineno">  621 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">#{ snippetClkGen }</span></span></span></span></span></span></span></span></span>
<span class="lineno">  622 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span></span></span></span></span></span></span>
<span class="lineno">  623 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">// vcd dump</span></span></span></span></span></span></span></span></span>
<span class="lineno">  624 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">#{ snippetDumpFile $ moduleName pName bn }</span></span></span></span></span></span></span></span></span>
<span class="lineno">  625 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span></span></span></span></span></span></span>
<span class="lineno">  626 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span></span></span></span></span></span></span>
<span class="lineno">  627 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">////////////////////////////////////////////////////////////</span></span></span></span></span></span></span></span></span>
<span class="lineno">  628 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">// test environment</span></span></span></span></span></span></span></span></span>
<span class="lineno">  629 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span></span></span></span></span></span></span>
<span class="lineno">  630 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">// external ports (IO)</span></span></span></span></span></span></span></span></span>
<span class="lineno">  631 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">#{ if null externalPortNames then &quot;&quot; else &quot;wire &quot; &lt;&gt; hsep (punctuate &quot;, &quot; externalPortNames) &lt;&gt; &quot;;&quot; }</span></span></span></span></span></span></span></span></span>
<span class="lineno">  632 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span></span></span></span></span></span></span>
<span class="lineno">  633 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">// initialization flags</span></span></span></span></span></span></span></span></span>
<span class="lineno">  634 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">#{ if null envInitFlags then &quot;&quot; else &quot;reg &quot; &lt;&gt; hsep (punctuate &quot;, &quot; envInitFlags) &lt;&gt; &quot;;&quot; }</span></span></span></span></span></span></span></span></span>
<span class="lineno">  635 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">assign env_init_flag = #{ hsep $ defEnvInitFlag envInitFlags ioSync };</span></span></span></span></span></span></span></span></span>
<span class="lineno">  636 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span></span></span></span></span></span></span>
<span class="lineno">  637 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">#{ testEnv }</span></span></span></span></span></span></span></span></span>
<span class="lineno">  638 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span></span></span></span></span></span></span>
<span class="lineno">  639 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span></span></span></span></span></span></span>
<span class="lineno">  640 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">////////////////////////////////////////////////////////////</span></span></span></span></span></span></span></span></span>
<span class="lineno">  641 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">// unit under test</span></span></span></span></span></span></span></span></span>
<span class="lineno">  642 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span></span></span></span></span></span></span>
<span class="lineno">  643 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">#{ moduleName pName bn } \#</span></span></span></span></span></span></span></span></span>
<span class="lineno">  644 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">( .DATA_WIDTH( #{ dataWidth (def :: x) } )</span></span></span></span></span></span></span></span></span>
<span class="lineno">  645 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .ATTR_WIDTH( #{ attrWidth (def :: x) } )</span></span></span></span></span></span></span></span></span>
<span class="lineno">  646 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">) #{ toString bnName }</span></span></span></span></span></span></span></span></span>
<span class="lineno">  647 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">( .clk( clk )</span></span></span></span></span></span></span></span></span>
<span class="lineno">  648 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .rst( rst )</span></span></span></span></span></span></span></span></span>
<span class="lineno">  649 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .flag_cycle_begin( cycle )</span></span></span></span></span></span></span></span></span>
<span class="lineno">  650 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">#{ nest 4 externalIO }</span></span></span></span></span></span></span></span></span>
<span class="lineno">  651 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">// if 1 - The process cycle are indipendent from a SPI.</span></span></span></span></span></span></span></span></span>
<span class="lineno">  652 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">// else - The process cycle are wait for the SPI.</span></span></span></span></span></span></span></span></span>
<span class="lineno">  653 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .is_drop_allow( #{ isDrowAllowSignal ioSync } )</span></span></span></span></span></span></span></span></span>
<span class="lineno">  654 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">);</span></span></span></span></span></span></span></span></span>
<span class="lineno">  655 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span></span></span></span></span></span></span>
<span class="lineno">  656 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">// internal unit under test checks</span></span></span></span></span></span></span></span></span>
<span class="lineno">  657 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">initial</span></span></span></span></span></span></span></span></span>
<span class="lineno">  658 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">begin</span></span></span></span></span></span></span></span></span>
<span class="lineno">  659 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">// microcode when rst == 1 -&gt; program[0], and must be nop for all PUs</span></span></span></span></span></span></span></span></span>
<span class="lineno">  660 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">@(negedge rst); // Turn mUnit on.</span></span></span></span></span></span></span></span></span>
<span class="lineno">  661 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">// Start computational cycle from program[1] to program[n] and repeat.</span></span></span></span></span></span></span></span></span>
<span class="lineno">  662 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">// Signals effect to mUnit state after first clk posedge.</span></span></span></span></span></span></span></span></span>
<span class="lineno">  663 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">@(posedge clk);</span></span></span></span></span></span></span></span></span>
<span class="lineno">  664 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">while (!env_init_flag) @(posedge clk);</span></span></span></span></span></span></span></span></span>
<span class="lineno">  665 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">#{ nest 8 assertions }</span></span></span></span></span></span></span></span></span>
<span class="lineno">  666 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">repeat ( #{ 2 * nextTick bn } ) @(posedge clk);</span></span></span></span></span></span></span></span></span>
<span class="lineno">  667 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">$finish;</span></span></span></span></span></span></span></span></span>
<span class="lineno">  668 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">end</span></span></span></span></span></span></span></span></span>
<span class="lineno">  669 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span></span></span></span></span></span></span>
<span class="lineno">  670 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">// TIMEOUT</span></span></span></span></span></span></span></span></span>
<span class="lineno">  671 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">initial</span></span></span></span></span></span></span></span></span>
<span class="lineno">  672 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">begin</span></span></span></span></span></span></span></span></span>
<span class="lineno">  673 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">repeat (100000) @(posedge clk);</span></span></span></span></span></span></span></span></span>
<span class="lineno">  674 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">$display(&quot;FAIL too long simulation process&quot;);</span></span></span></span></span></span></span></span></span>
<span class="lineno">  675 </span><span class="spaces">                                </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">$finish;</span></span></span></span></span></span></span></span></span>
<span class="lineno">  676 </span><span class="spaces">                            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">end</span></span></span></span></span></span></span></span></span>
<span class="lineno">  677 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span></span></span></span></span></span></span>
<span class="lineno">  678 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">////////////////////////////////////////////////////////////</span></span></span></span></span></span></span></span></span>
<span class="lineno">  679 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">// Utils</span></span></span></span></span></span></span></span></span>
<span class="lineno">  680 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">#{ verilogHelper (def :: x) }</span></span></span></span></span></span></span></span></span>
<span class="lineno">  681 </span><span class="spaces"></span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"></span></span></span></span></span></span></span></span></span>
<span class="lineno">  682 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">endmodule</span></span></span></span></span></span></span></span></span>
<span class="lineno">  683 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">|]</span></span></span></span></span></span></span></span></span>
<span class="lineno">  684 </span><span class="spaces">                    </span><span class="istickedoff">, Immediate (toString $ tbName &lt;&gt; &quot;.gtkw&quot;) $</span>
<span class="lineno">  685 </span><span class="spaces">                        </span><span class="istickedoff">T.pack</span>
<span class="lineno">  686 </span><span class="spaces">                            </span><span class="istickedoff">[__i|</span>
<span class="lineno">  687 </span><span class="spaces">                                </span><span class="istickedoff">[*]</span>
<span class="lineno">  688 </span><span class="spaces">                                </span><span class="istickedoff">[*] GTKWave Analyzer v3.3.107 (w)1999-2020 BSI</span>
<span class="lineno">  689 </span><span class="spaces">                                </span><span class="istickedoff">[*] Fri Mar 12 11:37:55 2021</span>
<span class="lineno">  690 </span><span class="spaces">                                </span><span class="istickedoff">[*]</span>
<span class="lineno">  691 </span><span class="spaces">                                </span><span class="istickedoff">[dumpfile] &quot;{{ nitta.paths.abs_nitta }}/#{ tbName }.vcd&quot;</span>
<span class="lineno">  692 </span><span class="spaces">                                </span><span class="istickedoff">[timestart] 0</span>
<span class="lineno">  693 </span><span class="spaces">                                </span><span class="istickedoff">*-6.864726 0 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1</span>
<span class="lineno">  694 </span><span class="spaces">                                </span><span class="istickedoff">[treeopen] #{ tbName }.</span>
<span class="lineno">  695 </span><span class="spaces">                                </span><span class="istickedoff">[treeopen] #{ tbName }.#{ toString bnName }.</span>
<span class="lineno">  696 </span><span class="spaces">                                </span><span class="istickedoff">[sst_width] 193</span>
<span class="lineno">  697 </span><span class="spaces">                                </span><span class="istickedoff">[signals_width] 203</span>
<span class="lineno">  698 </span><span class="spaces">                                </span><span class="istickedoff">[sst_expanded] 1</span>
<span class="lineno">  699 </span><span class="spaces">                                </span><span class="istickedoff">[sst_vpaned_height] 167</span>
<span class="lineno">  700 </span><span class="spaces">                                </span><span class="istickedoff">@28</span>
<span class="lineno">  701 </span><span class="spaces">                                </span><span class="istickedoff">#{ tbName }.clk</span>
<span class="lineno">  702 </span><span class="spaces">                                </span><span class="istickedoff">#{ tbName }.rst</span>
<span class="lineno">  703 </span><span class="spaces">                                </span><span class="istickedoff">#{ tbName }.cycle</span>
<span class="lineno">  704 </span><span class="spaces">                                </span><span class="istickedoff">@24</span>
<span class="lineno">  705 </span><span class="spaces">                                </span><span class="istickedoff">#{ tbName }.#{ toString bnName }.control_unit.pc[5:0]</span>
<span class="lineno">  706 </span><span class="spaces">                                </span><span class="istickedoff">@28</span>
<span class="lineno">  707 </span><span class="spaces">                                </span><span class="istickedoff">#{ tbName }.#{ toString bnName }.control_unit.flag_cycle_begin</span>
<span class="lineno">  708 </span><span class="spaces">                                </span><span class="istickedoff">#{ tbName }.#{ toString bnName }.control_unit.flag_cycle_end</span>
<span class="lineno">  709 </span><span class="spaces">                                </span><span class="istickedoff">@25</span>
<span class="lineno">  710 </span><span class="spaces">                                </span><span class="istickedoff">#{ tbName }.#{ toString bnName }.data_bus[31:0]</span>
<span class="lineno">  711 </span><span class="spaces">                                </span><span class="istickedoff">@22</span>
<span class="lineno">  712 </span><span class="spaces">                                </span><span class="istickedoff">#{ tbName }.#{ toString bnName }.attr_bus[3:0]</span>
<span class="lineno">  713 </span><span class="spaces">                                </span><span class="istickedoff">[pattern_trace] 1</span>
<span class="lineno">  714 </span><span class="spaces">                                </span><span class="istickedoff">[pattern_trace] 0</span>
<span class="lineno">  715 </span><span class="spaces">                                </span><span class="istickedoff">|]</span>
<span class="lineno">  716 </span><span class="spaces">                    </span><span class="istickedoff">]</span>
<span class="lineno">  717 </span><span class="spaces">            </span><span class="istickedoff">where</span>
<span class="lineno">  718 </span><span class="spaces">                </span><span class="istickedoff">defEnvInitFlag flags Sync = punctuate &quot; &amp;&amp; &quot; $ &quot;1'b1&quot; : flags</span>
<span class="lineno">  719 </span><span class="spaces">                </span><span class="istickedoff">defEnvInitFlag flags ASync = punctuate &quot; || &quot; $ &quot;1'b1&quot; : flags</span>
<span class="lineno">  720 </span><span class="spaces">                </span><span class="istickedoff">defEnvInitFlag _flags OnBoard = <span class="nottickedoff">error &quot;can't generate testbench without specific IOSynchronization&quot;</span></span>
<span class="lineno">  721 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  722 </span><span class="spaces">                </span><span class="istickedoff">cntxToTransfer cycleCntx t =</span>
<span class="lineno">  723 </span><span class="spaces">                    </span><span class="istickedoff">case extractInstructionAt bn t of</span>
<span class="lineno">  724 </span><span class="spaces">                        </span><span class="istickedoff">Transport v _ _ : _ -&gt; Just (v, getCntx cycleCntx v)</span>
<span class="lineno">  725 </span><span class="spaces">                        </span><span class="istickedoff">_ -&gt; Nothing</span>
<span class="lineno">  726 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  727 </span><span class="spaces">                </span><span class="istickedoff">posedgeCycle =</span>
<span class="lineno">  728 </span><span class="spaces">                    </span><span class="istickedoff">[__i|</span>
<span class="lineno">  729 </span><span class="spaces">                        </span><span class="istickedoff">//-----------------------------------------------------------------</span>
<span class="lineno">  730 </span><span class="spaces">                        </span><span class="istickedoff">@(posedge cycle);</span>
<span class="lineno">  731 </span><span class="spaces">                    </span><span class="istickedoff">|]</span></span>
<span class="lineno">  732 </span>
<span class="lineno">  733 </span><span class="decl"><span class="istickedoff">isDrowAllowSignal Sync = bool2verilog False</span>
<span class="lineno">  734 </span><span class="spaces"></span><span class="istickedoff">isDrowAllowSignal ASync = bool2verilog True</span>
<span class="lineno">  735 </span><span class="spaces"></span><span class="istickedoff">isDrowAllowSignal OnBoard = <span class="nottickedoff">&quot;is_drop_allow&quot;</span></span></span>

</pre>
</body>
</html>
