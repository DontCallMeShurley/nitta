<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE PartialTypeSignatures #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE QuasiQuotes #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# OPTIONS -fno-warn-partial-type-signatures #-}</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-comment">{- |
Module      : NITTA.UIBackend
Description : HTTP backend for the NITTA web UI
Copyright   : (c) Aleksandr Penskoi, 2019
License     : BSD3
Maintainer  : aleksandr.penskoi@gmail.com
Stability   : experimental
-}</span><span>
</span><span id="line-17"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">NITTA.UIBackend</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="NITTA.UIBackend.html#backendServer"><span class="hs-identifier">backendServer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="NITTA.UIBackend.html#prepareJSAPI"><span class="hs-identifier">prepareJSAPI</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="NITTA.UIBackend.html#restDocs"><span class="hs-identifier">restDocs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="NITTA.UIBackend.html#apiPath"><span class="hs-identifier">apiPath</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">SomeException</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">try</span></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unless</span></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Either</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fromJust</span></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.String.Interpolate</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.IO.Encoding</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">setLocaleEncoding</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">utf8</span></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="NITTA.UIBackend.REST.html"><span class="hs-identifier">NITTA.UIBackend.REST</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Simple.TCP</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">connect</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Wai.Application.Static</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Wai.Handler.Warp</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">run</span></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Wai.Middleware.Cors</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">simpleCors</span></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Servant</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Servant.Docs</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">path</span></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Servant.JS</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SJS</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.FilePath.Posix</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">joinPath</span></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">WaiAppStatic.Types</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">LookupResult</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">LRNotFound</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">toPieces</span></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span id="apiPath"><span class="annot"><span class="annottext">apiPath :: FilePath
</span><a href="NITTA.UIBackend.html#apiPath"><span class="hs-identifier hs-var hs-var">apiPath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[FilePath] -&gt; FilePath
</span><span class="hs-identifier hs-var">joinPath</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;.&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;web&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;src&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;services&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;gen&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-42"></span><span id="frontendPath"><span class="annot"><span class="annottext">frontendPath :: FilePath
</span><a href="NITTA.UIBackend.html#frontendPath"><span class="hs-identifier hs-var hs-var">frontendPath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[FilePath] -&gt; FilePath
</span><span class="hs-identifier hs-var">joinPath</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;web&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;build&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-43"></span><span id="frontendAppSettings"><span class="annot"><span class="annottext">frontendAppSettings :: StaticSettings
</span><a href="NITTA.UIBackend.html#frontendAppSettings"><span class="hs-identifier hs-var hs-var">frontendAppSettings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; StaticSettings
</span><span class="hs-identifier hs-var">defaultWebAppSettings</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="NITTA.UIBackend.html#frontendPath"><span class="hs-identifier hs-var">frontendPath</span></a></span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span id="restDocs"><span class="annot"><span class="annottext">restDocs :: a -&gt; FilePath
</span><a href="NITTA.UIBackend.html#restDocs"><span class="hs-identifier hs-var hs-var">restDocs</span></a></span></span><span> </span><span id="local-6989586621680221887"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680221887"><span class="hs-identifier hs-var">port</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><span class="annottext">API -&gt; FilePath
</span><span class="hs-identifier hs-var">markdown</span></span><span>
</span><span id="line-47"></span><span>        </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall {k} (api :: k).
HasDocs api =&gt;
[DocIntro] -&gt; Proxy api -&gt; API
</span><span class="hs-identifier hs-var">docsWithIntros</span></span><span>
</span><span id="line-48"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; [FilePath] -&gt; DocIntro
</span><span class="hs-identifier hs-var">DocIntro</span></span><span>
</span><span id="line-49"></span><span>                </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;NITTA UI REST API description&quot;</span></span><span>
</span><span id="line-50"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Autogenerated by `nitta-api-gen`&quot;</span></span><span>
</span><span id="line-51"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Expected port: &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; FilePath
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680221887"><span class="hs-identifier hs-var">port</span></a></span><span>
</span><span id="line-52"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Request helper with axios can be finded here: &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;`rest_api.js`&quot;</span></span><span>
</span><span id="line-53"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Typescript interfaces can be finded here: &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;`types.ts`&quot;</span></span><span>
</span><span id="line-54"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-55"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-56"></span><span>        </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall {k} (api :: k). Proxy api -&gt; Proxy (Pretty api)
</span><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {k} (t :: k). Proxy t
</span><span class="hs-identifier hs-var">Proxy</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Proxy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="NITTA.UIBackend.REST.html#SynthesisAPI"><span class="hs-identifier hs-type">SynthesisAPI</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span id="prepareJSAPI"><span class="annot"><span class="annottext">prepareJSAPI :: p -&gt; FilePath -&gt; IO ()
</span><a href="NITTA.UIBackend.html#prepareJSAPI"><span class="hs-identifier hs-var hs-var">prepareJSAPI</span></a></span></span><span> </span><span id="local-6989586621680221710"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621680221710"><span class="hs-identifier hs-var">port</span></a></span></span><span> </span><span id="local-6989586621680221709"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621680221709"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-59"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680221702"><span class="annot"><span class="annottext">prefix :: Text
</span><a href="#local-6989586621680221702"><span class="hs-identifier hs-var hs-var">prefix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-60"></span><span>            </span><span class="annot"><span class="">[__i|
                import axios from 'axios';
                var jsAPI = {};
                export default jsAPI;
                /* eslint no-useless-concat: &quot;off&quot; */
            |]</span></span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680221690"><span class="annot"><span class="annottext">axios' :: JavaScriptGenerator
</span><a href="#local-6989586621680221690"><span class="hs-identifier hs-var hs-var">axios'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-67"></span><span>            </span><span class="annot"><span class="annottext">AxiosOptions -&gt; CommonGeneratorOptions -&gt; JavaScriptGenerator
</span><span class="hs-identifier hs-var">SJS.axiosWith</span></span><span>
</span><span id="line-68"></span><span>                </span><span class="annot"><span class="annottext">AxiosOptions
</span><span class="hs-identifier hs-var">SJS.defAxiosOptions</span></span><span>
</span><span id="line-69"></span><span>                </span><span class="annot"><span class="annottext">CommonGeneratorOptions
</span><span class="hs-identifier hs-var">SJS.defCommonGeneratorOptions</span></span><span>
</span><span id="line-70"></span><span>                    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">urlPrefix :: Text
</span><span class="hs-identifier hs-var">SJS.urlPrefix</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[i|http://localhost:#{ port }|]</span></span><span>
</span><span id="line-71"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">moduleName :: Text
</span><span class="hs-identifier hs-var">SJS.moduleName</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;jsAPI&quot;</span></span><span>
</span><span id="line-72"></span><span>                    </span><span class="hs-special">}</span><span>
</span><span id="line-73"></span><span>    </span><span class="annot"><span class="annottext">forall api.
(HasForeign NoTypes NoContent api,
 GenerateList NoContent (Foreign NoContent api)) =&gt;
Proxy api -&gt; JavaScriptGenerator -&gt; FilePath -&gt; IO ()
</span><span class="hs-identifier hs-var">SJS.writeJSForAPI</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {k} (t :: k). Proxy t
</span><span class="hs-identifier hs-var">Proxy</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Proxy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="NITTA.UIBackend.REST.html#SynthesisAPI"><span class="hs-identifier hs-type">SynthesisAPI</span></a></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680221702"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">JavaScriptGenerator
</span><a href="#local-6989586621680221690"><span class="hs-identifier hs-var">axios'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[FilePath] -&gt; FilePath
</span><span class="hs-identifier hs-var">joinPath</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621680221709"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;rest_api.js&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span id="fileOrIndex"><span class="annot"><span class="annottext">fileOrIndex :: Pieces -&gt; IO LookupResult
</span><a href="NITTA.UIBackend.html#fileOrIndex"><span class="hs-identifier hs-var hs-var">fileOrIndex</span></a></span></span><span> </span><span id="local-6989586621680221674"><span class="annot"><span class="annottext">Pieces
</span><a href="#local-6989586621680221674"><span class="hs-identifier hs-var">pieces</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-76"></span><span>    </span><span id="local-6989586621680221673"><span class="annot"><span class="annottext">LookupResult
</span><a href="#local-6989586621680221673"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StaticSettings -&gt; Pieces -&gt; IO LookupResult
</span><span class="hs-identifier hs-var">ssLookupFile</span></span><span> </span><span class="annot"><span class="annottext">StaticSettings
</span><a href="NITTA.UIBackend.html#frontendAppSettings"><span class="hs-identifier hs-var">frontendAppSettings</span></a></span><span> </span><span class="annot"><span class="annottext">Pieces
</span><a href="#local-6989586621680221674"><span class="hs-identifier hs-var">pieces</span></a></span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LookupResult
</span><a href="#local-6989586621680221673"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-78"></span><span>        </span><span class="annot"><span class="annottext">LookupResult
</span><span class="hs-identifier hs-var">LRNotFound</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-79"></span><span>            </span><span class="annot"><span class="annottext">StaticSettings -&gt; Pieces -&gt; IO LookupResult
</span><span class="hs-identifier hs-var">ssLookupFile</span></span><span> </span><span class="annot"><span class="annottext">StaticSettings
</span><a href="NITTA.UIBackend.html#frontendAppSettings"><span class="hs-identifier hs-var">frontendAppSettings</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromJust</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Maybe Pieces
</span><span class="hs-identifier hs-var">toPieces</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;index.html&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-80"></span><span>        </span><span class="annot"><span class="annottext">LookupResult
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">LookupResult
</span><a href="#local-6989586621680221673"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span id="application"><span class="annot"><span class="annottext">application :: [(w, [w])] -&gt; DefTree w w w w -&gt; FilePath -&gt; m Application
</span><a href="NITTA.UIBackend.html#application"><span class="hs-identifier hs-var hs-var">application</span></a></span></span><span> </span><span id="local-6989586621680221350"><span class="annot"><span class="annottext">[(w, [w])]
</span><a href="#local-6989586621680221350"><span class="hs-identifier hs-var">receivedValues</span></a></span></span><span> </span><span id="local-6989586621680221349"><span class="annot"><span class="annottext">DefTree w w w w
</span><a href="#local-6989586621680221349"><span class="hs-identifier hs-var">synthesisRoot</span></a></span></span><span> </span><span id="local-6989586621680221348"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621680221348"><span class="hs-identifier hs-var">outputPath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-83"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-84"></span><span>        </span><span class="annot"><span class="annottext">forall api.
HasServer api '[] =&gt;
Proxy api -&gt; Server api -&gt; Application
</span><span class="hs-identifier hs-var">serve</span></span><span>
</span><span id="line-85"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">forall {k} (t :: k). Proxy t
</span><span class="hs-identifier hs-var">Proxy</span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-86"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Proxy</span></span><span>
</span><span id="line-87"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="NITTA.UIBackend.REST.html#SynthesisAPI"><span class="hs-identifier hs-type">SynthesisAPI</span></a></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span>
</span><span id="line-88"></span><span>                        </span><span class="annot"><span class="hs-operator hs-type">:&lt;|&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Get</span></span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">JSON</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- root</span><span>
</span><span id="line-89"></span><span>                        </span><span class="annot"><span class="hs-operator hs-type">:&lt;|&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Raw</span></span><span>
</span><span id="line-90"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">forall {tag} {v} {x} {a} {m1 :: * -&gt; *} {m2 :: * -&gt; *}
       {m3 :: * -&gt; *} {m4 :: * -&gt; *} {m5 :: * -&gt; *} {m6 :: * -&gt; *}
       {m7 :: * -&gt; *} {m8 :: * -&gt; *} {m9 :: * -&gt; *} {m10 :: * -&gt; *}
       {m11 :: * -&gt; *} {m12 :: * -&gt; *} {m13 :: * -&gt; *} {m14 :: * -&gt; *}
       {m15 :: * -&gt; *} {m16 :: * -&gt; *} {m17 :: * -&gt; *} {m18 :: * -&gt; *}
       {m19 :: * -&gt; *} {m20 :: * -&gt; *} {m21 :: * -&gt; *}.
(UnitTag tag, Suffix v, Hashable v, Val x, Bounded a, ToJSONKey v,
 ToJSON v, ToJSON x, ToJSON a, Label v, MonadIO m1, MonadIO m2,
 MonadIO m3, MonadIO m4, MonadIO m5, MonadIO m6, MonadIO m7,
 MonadIO m8, MonadIO m9, MonadIO m10, MonadIO m11, MonadIO m12,
 MonadIO m13, MonadIO m14, MonadIO m15, MonadIO m16, MonadIO m17,
 MonadIO m18, MonadIO m19, MonadIO m20, MonadIO m21, Show a,
 Default a, Integral a, Typeable v, Typeable a, Ord v, ToString v,
 IsString v) =&gt;
BackendCtx tag v x a
-&gt; m2 (TreeView ShortNodeView)
   :&lt;|&gt; (m1 TreeInfo
         :&lt;|&gt; (Sid
               -&gt; (m4 [NodeView tag v x a]
                   :&lt;|&gt; (m5 (Maybe (NodeView tag v x a))
                         :&lt;|&gt; m3 [NodeView tag v x a]))
                  :&lt;|&gt; ((m8 (NodeView tag v x a)
                         :&lt;|&gt; (m7 (GraphStructure GraphEdge)
                               :&lt;|&gt; (m6 (ProcessTimelines a)
                                     :&lt;|&gt; (m9 (Process a StepInfoView)
                                           :&lt;|&gt; ((tag -&gt; m10 (Process a StepInfoView))
                                                 :&lt;|&gt; (m11 [UnitEndpoints tag v a]
                                                       :&lt;|&gt; (m12 (MicroarchitectureDesc tag)
                                                             :&lt;|&gt; m13 (Debug tag v a))))))))
                        :&lt;|&gt; ((FilePath -&gt; Int -&gt; m14 (TestbenchReport v x))
                              :&lt;|&gt; ((m15 Sid :&lt;|&gt; (m16 Sid :&lt;|&gt; m17 Sid))
                                    :&lt;|&gt; (m18 Sid
                                          :&lt;|&gt; (m19 Sid :&lt;|&gt; (m20 Sid :&lt;|&gt; (Int -&gt; m21 Sid)))))))))
</span><a href="NITTA.UIBackend.REST.html#synthesisServer"><span class="hs-identifier hs-var">synthesisServer</span></a></span><span> </span><span class="annot"><a href="NITTA.UIBackend.REST.html#BackendCtx"><span class="hs-identifier hs-type">BackendCtx</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:root:BackendCtx :: DefTree w w w w
</span><a href="NITTA.UIBackend.REST.html#%24sel%3Aroot%3ABackendCtx"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DefTree w w w w
</span><a href="#local-6989586621680221349"><span class="hs-identifier hs-var">synthesisRoot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(w, [w])]
$sel:receivedValues:BackendCtx :: [(w, [w])]
receivedValues :: [(w, [w])]
</span><a href="NITTA.UIBackend.REST.html#%24sel%3AreceivedValues%3ABackendCtx"><span class="hs-identifier hs-var hs-var">receivedValues</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FilePath
$sel:outputPath:BackendCtx :: FilePath
outputPath :: FilePath
</span><a href="NITTA.UIBackend.REST.html#%24sel%3AoutputPath%3ABackendCtx"><span class="hs-identifier hs-var hs-var">outputPath</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-93"></span><span>                </span><span class="annot"><span class="annottext">forall a b. a -&gt; b -&gt; a :&lt;|&gt; b
</span><span class="hs-operator hs-var">:&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">ServerError
</span><span class="hs-identifier hs-var">err301</span></span><span class="hs-special">{</span><span class="annot"><span class="annottext">errHeaders :: [Header]
</span><span class="hs-identifier hs-var">errHeaders</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderName
</span><span class="hs-string">&quot;Location&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;index.html&quot;</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">}</span><span>
</span><span id="line-94"></span><span>                </span><span class="annot"><span class="annottext">forall a b. a -&gt; b -&gt; a :&lt;|&gt; b
</span><span class="hs-operator hs-var">:&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). StaticSettings -&gt; ServerT Raw m
</span><span class="hs-identifier hs-var">serveDirectoryWith</span></span><span> </span><span class="annot"><span class="annottext">StaticSettings
</span><a href="NITTA.UIBackend.html#frontendAppSettings"><span class="hs-identifier hs-var">frontendAppSettings</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">ssLookupFile :: Pieces -&gt; IO LookupResult
</span><span class="hs-identifier hs-var">ssLookupFile</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pieces -&gt; IO LookupResult
</span><a href="NITTA.UIBackend.html#fileOrIndex"><span class="hs-identifier hs-var">fileOrIndex</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-95"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span id="isLocalPortFree"><span class="annot"><span class="annottext">isLocalPortFree :: a -&gt; IO Bool
</span><a href="NITTA.UIBackend.html#isLocalPortFree"><span class="hs-identifier hs-var hs-var">isLocalPortFree</span></a></span></span><span> </span><span id="local-6989586621680221324"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680221324"><span class="hs-identifier hs-var">port</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-98"></span><span>    </span><span class="annot"><span class="annottext">forall a b. Either a b -&gt; Bool
</span><span class="hs-identifier hs-var">isLeft</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall e a. Exception e =&gt; IO a -&gt; IO (Either e a)
</span><span class="hs-identifier hs-var">try</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) r.
(MonadIO m, MonadMask m) =&gt;
FilePath -&gt; FilePath -&gt; ((Socket, SockAddr) -&gt; m r) -&gt; m r
</span><span class="hs-identifier hs-var">connect</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;localhost&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; FilePath
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680221324"><span class="hs-identifier hs-var">port</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">(Socket, SockAddr)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="hs-comment">-- | Run backend server.</span><span>
</span><span id="line-101"></span><span id="backendServer"><span class="annot"><span class="annottext">backendServer :: Int -&gt; [(w, [w])] -&gt; FilePath -&gt; DefTree w w w w -&gt; IO ()
</span><a href="NITTA.UIBackend.html#backendServer"><span class="hs-identifier hs-var hs-var">backendServer</span></a></span></span><span> </span><span id="local-6989586621680221264"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680221264"><span class="hs-identifier hs-var">port</span></a></span></span><span> </span><span id="local-6989586621680221263"><span class="annot"><span class="annottext">[(w, [w])]
</span><a href="#local-6989586621680221263"><span class="hs-identifier hs-var">receivedValues</span></a></span></span><span> </span><span id="local-6989586621680221262"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621680221262"><span class="hs-identifier hs-var">outputPath</span></a></span></span><span> </span><span id="local-6989586621680221261"><span class="annot"><span class="annottext">DefTree w w w w
</span><a href="#local-6989586621680221261"><span class="hs-identifier hs-var">synthesisRoot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Running NITTA server at http://localhost:&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; FilePath
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680221264"><span class="hs-identifier hs-var">port</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot; ...&quot;</span></span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-comment">-- on OS X, if we run system with busy port - application ignore that.</span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-comment">-- see: https://nitta.io/nitta-corp/nitta/issues/9</span><span>
</span><span id="line-105"></span><span>    </span><span id="local-6989586621680221259"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680221259"><span class="hs-identifier hs-var">isFree</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall {a}. Show a =&gt; a -&gt; IO Bool
</span><a href="NITTA.UIBackend.html#isLocalPortFree"><span class="hs-identifier hs-var">isLocalPortFree</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680221264"><span class="hs-identifier hs-var">port</span></a></span><span>
</span><span id="line-106"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680221259"><span class="hs-identifier hs-var">isFree</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; FilePath -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;resource busy (Port already in use)&quot;</span></span><span>
</span><span id="line-107"></span><span>    </span><span id="local-6989586621680221257"><span class="annot"><span class="annottext">Application
</span><a href="#local-6989586621680221257"><span class="hs-identifier hs-var">app</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {w} {w} {w} {w}.
(Monad m, Suffix w, Hashable w, Val w, Bounded w, ToJSONKey w,
 ToJSON w, ToJSON w, ToJSON w, ToJSON w, FromHttpApiData w,
 UnitTag w, Label w, ToString w, IsString w, Typeable w, Typeable w,
 Show w, Default w, Integral w, Ord w) =&gt;
[(w, [w])] -&gt; DefTree w w w w -&gt; FilePath -&gt; m Application
</span><a href="NITTA.UIBackend.html#application"><span class="hs-identifier hs-var">application</span></a></span><span> </span><span class="annot"><span class="annottext">[(w, [w])]
</span><a href="#local-6989586621680221263"><span class="hs-identifier hs-var">receivedValues</span></a></span><span> </span><span class="annot"><span class="annottext">DefTree w w w w
</span><a href="#local-6989586621680221261"><span class="hs-identifier hs-var">synthesisRoot</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621680221262"><span class="hs-identifier hs-var">outputPath</span></a></span><span>
</span><span id="line-108"></span><span>    </span><span class="annot"><span class="annottext">TextEncoding -&gt; IO ()
</span><span class="hs-identifier hs-var">setLocaleEncoding</span></span><span> </span><span class="annot"><span class="annottext">TextEncoding
</span><span class="hs-identifier hs-var">utf8</span></span><span>
</span><span id="line-109"></span><span>    </span><span class="annot"><span class="annottext">Int -&gt; Application -&gt; IO ()
</span><span class="hs-identifier hs-var">run</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680221264"><span class="hs-identifier hs-var">port</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Middleware
</span><span class="hs-identifier hs-var">simpleCors</span></span><span> </span><span class="annot"><span class="annottext">Application
</span><a href="#local-6989586621680221257"><span class="hs-identifier hs-var">app</span></a></span><span>
</span><span id="line-110"></span></pre></body></html>